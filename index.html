<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="ch-ua-form-factors=*">
    <title>Menu</title>
    <link rel="stylesheet" href="Main-Modern.css">
    <link rel="stylesheet" href="management-styles.css">
    <link rel="stylesheet" href="gear-wheel.css">
    <link rel="stylesheet" href="equipment.css">

    <!-- YouTube IFrame API -->
    <script>
        // Preload YouTube API
        console.log("üéµ Loading YouTube IFrame API...");
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        tag.onerror = function() {
            console.error("‚ùå Failed to load YouTube IFrame API");
        };
        tag.onload = function() {
            console.log("‚úÖ YouTube IFrame API script loaded successfully");
        };
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    </script>
</head>

<body>
    <!-- Discover Page - Comic Style -->
    <div id="discoverPage" class="discover-page">
        <div class="discover-container">
            <!-- Close Button (inside container) -->
            <button class="discover-close" id="closeDiscover">&times;</button>

            <!-- Header Section -->
            <div class="discover-header">
                <div class="comic-burst header-burst">
                    <span>DISCOVER</span>
                </div>
                <p class="discover-subtitle">Your Ultimate Extreme Sports Experience!</p>
            </div>

            <!-- Main Content Grid -->
            <div class="discover-content">
                <!-- Left Column - Sports Showcase -->
                <div class="discover-column sports-column">
                    <div class="comic-panel sports-panel">
                        <div class="panel-header">
                            <span class="comic-text">üèÇ AVAILABLE SPORTS</span>
                        </div>
                        <div class="sports-grid">
                            <div class="sport-card" data-sport="skateboard">
                                <img src="images/icons/skateboard.png" alt="Skateboard">
                                <span>Skateboard</span>
                            </div>
                            <div class="sport-card" data-sport="bmx">
                                <img src="images/icons/bmx.png" alt="BMX">
                                <span>BMX</span>
                            </div>
                            <div class="sport-card" data-sport="scooter">
                                <img src="images/icons/scooter.png" alt="Scooter">
                                <span>Scooter</span>
                            </div>
                            <div class="sport-card" data-sport="rollers">
                                <img src="images/icons/rollers.png" alt="Rollers">
                                <span>Rollers</span>
                            </div>
                            <div class="sport-card" data-sport="hoverboard">
                                <img src="images/icons/hoverboard.png" alt="Hoverboard">
                                <span>Hoverboard</span>
                            </div>
                            <div class="sport-card" data-sport="skis">
                                <img src="images/icons/skis.png" alt="Ski">
                                <span>Ski</span>
                            </div>
                            <div class="sport-card" data-sport="snowboard">
                                <img src="images/icons/snowboard.png" alt="Snowboard">
                                <span>Snowboard</span>
                            </div>
                            <div class="sport-card" data-sport="iceskates">
                                <img src="images/icons/iceskates.png" alt="Ice Skates">
                                <span>Ice Skates</span>
                            </div>
                        </div>
                        <div class="sports-note">
                            <strong>Note:</strong> Available sports depend on what your server owner has installed. You'll only see the sports enabled on this server.
                        </div>
                    </div>

                    <!-- Equipment Showcase Section -->
                    <div class="comic-panel equipment-showcase-panel">
                        <div class="panel-header">
                            <span class="comic-text">üõ°Ô∏è EQUIPMENT SHOWCASE</span>
                        </div>
                        <div class="equipment-categories">
                            <div class="equip-category">
                                <div class="equip-category-title">ü™ñ Helmets</div>
                                <div class="equip-preview-grid">
                                    <img src="images/Equipment/ht/dragon.png" alt="Dragon" class="equip-preview-img">
                                    <img src="images/Equipment/ht/predatore.png" alt="Predatore" class="equip-preview-img">
                                    <img src="images/Equipment/ht/tech_king.png" alt="Tech King" class="equip-preview-img">
                                    <img src="images/Equipment/ht/evil_viking.png" alt="Evil Viking" class="equip-preview-img">
                                </div>
                            </div>
                            <div class="equip-category">
                                <div class="equip-category-title">üí™ Forearms</div>
                                <div class="equip-preview-grid">
                                    <img src="images/Equipment/fr/fr_chrome.png" alt="Chrome" class="equip-preview-img">
                                    <img src="images/Equipment/fr/fr_red_galaxy.png" alt="Red Galaxy" class="equip-preview-img">
                                    <img src="images/Equipment/fr/fr_ice.png" alt="Ice" class="equip-preview-img">
                                    <img src="images/Equipment/fr/fr_purpure_gold.png" alt="Purple Gold" class="equip-preview-img">
                                </div>
                            </div>
                            <div class="equip-category">
                                <div class="equip-category-title">ü¶µ Shinguards</div>
                                <div class="equip-preview-grid">
                                    <img src="images/Equipment/sh/kn_gold_thunder.png" alt="Gold Thunder" class="equip-preview-img">
                                    <img src="images/Equipment/sh/kn_red_galaxy.png" alt="Red Galaxy" class="equip-preview-img">
                                    <img src="images/Equipment/sh/kn_white_space.png" alt="White Space" class="equip-preview-img">
                                    <img src="images/Equipment/sh/kn_oxid_neon.png" alt="Oxid Neon" class="equip-preview-img">
                                </div>
                            </div>
                        </div>
                        <div class="equip-cta">
                            <span>üé® 23 Helmets ‚Ä¢ 14 Forearms ‚Ä¢ 12 Shinguards</span>
                        </div>
                    </div>
                </div>

                <!-- Right Column - VIP Section -->
                <div class="discover-column vip-column">
                    <div class="comic-panel vip-panel">
                        <div class="vip-badge">
                            <span class="vip-star">‚≠ê</span>
                            <span class="vip-text">VIP</span>
                            <span class="vip-star">‚≠ê</span>
                        </div>

                        <div class="vip-image-container">
                            <img src="images/discover/pack-1.jpg" alt="VIP Package" class="vip-package-image">
                            <div class="comic-burst vip-burst">
                                <span>EXCLUSIVE!</span>
                            </div>
                        </div>

                        <div class="vip-details">
                            <h3 class="vip-title">üåü NEO XTREME üåü</h3>
                            <p class="vip-description">Unlock the ultimate extreme sports experience with exclusive VIP benefits!</p>

                            <ul class="vip-features">
                                <li><span class="check">‚úì</span> Exclusive VIP-only gear designs</li>
                                <li><span class="check">‚úì</span> Premium equipment skins</li>
                                <li><span class="check">‚úì</span> Special VIP badge & recognition</li>
                                <li><span class="check">‚úì</span> Early access to new content</li>
                                <li><span class="check">‚úì</span> Discord VIP role & perks</li>
                            </ul>

                            <button class="vip-purchase-btn" id="discoverVipPurchase">
                                <span class="btn-text">GET NEO XTREME</span>
                                <span class="btn-price" id="discoverVipPrice">$5</span>
                            </button>
                        </div>

                        <div class="vip-decoration">
                            <div class="sparkle s1">‚ú®</div>
                            <div class="sparkle s2">‚ú®</div>
                            <div class="sparkle s3">‚ú®</div>
                        </div>
                    </div>

                    <!-- Features Highlight -->
                    <div class="comic-panel features-highlight-panel">
                        <div class="panel-header">
                            <span class="comic-text">üî• FEATURES</span>
                        </div>
                        <div class="features-list">
                            <div class="feature-highlight">
                                <span class="feature-emoji">üé®</span>
                                <span>Custom Gear Designs</span>
                            </div>
                            <div class="feature-highlight">
                                <span class="feature-emoji">üõí</span>
                                <span>In-Game Shops</span>
                            </div>
                            <div class="feature-highlight">
                                <span class="feature-emoji">üéµ</span>
                                <span>Shop Music System</span>
                            </div>
                            <div class="feature-highlight">
                                <span class="feature-emoji">‚öôÔ∏è</span>
                                <span>Gear Wheel Menu</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="discover-footer">
                <div class="comic-speech">
                    <span>Made with ‚ù§Ô∏è by Bodhix's Studio</span>
                </div>
            </div>
        </div>

        <!-- Background Effects -->
        <div class="discover-bg-effects">
            <div class="halftone-overlay"></div>
            <div class="comic-dots"></div>
        </div>
    </div>

    <!-- Purchase Prompt Modal -->
    <div id="purchasePromptModal" class="modal" style="display: none;">
        <div class="purchase-prompt-content">
            <h2 id="purchasePromptTitle">Purchase Required</h2>
            <p id="purchasePromptMessage">You need to purchase this item first.</p>
            <div class="purchase-prompt-buttons">
                <button class="purchase-prompt-btn purchase-yes" id="purchasePromptYes">Yes</button>
                <button class="purchase-prompt-btn purchase-no" id="purchasePromptNo">No</button>
            </div>
        </div>
    </div>

    <!-- Main -------------------------------------------------------------------------------------------------------------------------------------------->
    <div id="container" style="display: none;">
        <button class="closeMain" id="closeContainerNew">x</button> <!-- Bot√≥n de cierre -->
        <div class="menu-line left"></div>
        <div class="menu-title">Bodhix's Studio</div>
        <div class="menu-line right"></div>
        <div class="menu">

            <!-- <a href="best-spots.html" class="menu-item best-spots">
                <img src="images/Spots.jpg" alt="Best Spots">
            </a> -->

            <button class="menu-item best-spots" id="openEquipmentMenu">
                <img src="images/equipment.png" alt="Equipment">
                <span class="menu-text" id="equipmentBtn">Loading...</span>
            </button>

            <button class="menu-item select-sport" id="openMenuBox">
                <img src="images/gear.png" alt="Gear">
                <span class="menu-text" id="gearBtn">Loading...</span>
            </button>
            <button class="menu-item whats-new" id="openModal">
                <div class="features-container">
                    <img src="images/features/skate.jpg" alt="Feature 1" class="feature-img">
                    <img src="images/features/bmx.jpg" alt="Feature 2" class="feature-img">
                    <img src="images/features/ski.jpg" alt="Feature 3" class="feature-img">
                </div>
                <span class="menu-text" id="whatsNewBtn">Loading...</span>
            </button>
        </div>

        <!-- Secci√≥n de enlaces -->
        <div class="links">
            <img src="images/Logos/Discord.png"
                alt="Discord" class="social-icon discord-icon"
                onclick="window.invokeNative('openUrl', 'https://discord.com/invite/PjN7AWqkpF');">
            <img src="images/Logos/YouTube.png"
                alt="YouTube" class="social-icon youtube-icon"
                onclick="window.invokeNative('openUrl', 'https://youtube.com/@bodhix?si=qqenaPcA3cVcXf0b');">
        </div>

        <!-- Background decoration -->
        <div class="main-background-decoration"></div>
    </div>

    <div id="menuBox" style="display: none;">
        <!-- Gear section background -->
        <div class="gear-background-decoration"></div>

        <!-- Logo -->
        <img src="images/Logos/logo.png" alt="Logo" id="logo">

        <!-- First Page (Category Selection) -->
        <div id="firstPage">
            <div id="categoryButtons" class="buttons">
                <!-- Categories will be loaded dynamically -->
                <button class="back-arrow" onclick="goBack()">&#11013;</button>
            </div>
        </div>

        <!-- Main Menu (Style/Part Selection) -->
        <div id="mainMenu" style="display: none;">
            <div id="mainMenuButtons" class="buttons">
                <!-- Style or Part buttons will be loaded dynamically -->
                <button class="back-arrow" onclick="goBack()">&#11013;</button>
            </div>
        </div>

        <!-- Submenu -->
        <div id="subMenu" style="display: none;">
            <h1 id="submenu-title">Submenu</h1>
            <div id="options"></div>

            <button class="back-arrow" onclick="goBack()">&#11013;</button>
            <button class="purchase-button" id="purchaseBtn" onclick="purchaseItem()">Loading...</button>

            <!-- Model Rotation Controls (Below purchase button) -->
            <div id="rotationControls" class="rotation-controls" style="display: none;">
                <div class="rotation-label">Rotate Model</div>
                <div class="rotation-buttons-grid">
                    <!-- Row 1: Up button only (centered) -->
                    <div class="rotation-grid-row">
                        <button class="rotation-btn rotation-btn-up"
                                onmousedown="startRotation('up')"
                                onmouseup="stopRotation()"
                                onmouseleave="stopRotation()"
                                ontouchstart="startRotation('up')"
                                ontouchend="stopRotation()"
                                title="Rotate Up">‚ñ≤</button>
                    </div>
                    <!-- Row 2: Left - Down - Right in horizontal line -->
                    <div class="rotation-grid-row rotation-grid-main">
                        <button class="rotation-btn rotation-btn-left"
                                onmousedown="startRotation('left')"
                                onmouseup="stopRotation()"
                                onmouseleave="stopRotation()"
                                ontouchstart="startRotation('left')"
                                ontouchend="stopRotation()"
                                title="Rotate Left">‚óÑ</button>
                        <button class="rotation-btn rotation-btn-down"
                                onmousedown="startRotation('down')"
                                onmouseup="stopRotation()"
                                onmouseleave="stopRotation()"
                                ontouchstart="startRotation('down')"
                                ontouchend="stopRotation()"
                                title="Rotate Down">‚ñº</button>
                        <button class="rotation-btn rotation-btn-right"
                                onmousedown="startRotation('right')"
                                onmouseup="stopRotation()"
                                onmouseleave="stopRotation()"
                                ontouchstart="startRotation('right')"
                                ontouchend="stopRotation()"
                                title="Rotate Right">‚ñ∫</button>
                    </div>
                </div>
            </div>
            <!-----------------------------------------Usar Esto-------------------------------------------->
        </div>
    </div>


    <!-- Audio Players -->
    <audio id="audioPlayer1" src="" type="audio/mp3"></audio>
    <audio id="audioPlayer2" src="" type="audio/mp3"></audio>
    <audio id="audioPlayer3" src="" type="audio/mp3"></audio>

    <!-- Button Sound Effects -->
    <audio id="selectSound" src="sounds/select.MP3" preload="auto"></audio>
    <audio id="clickSound" src="sounds/click.MP3" preload="auto"></audio>

    <!-- Background Music Player (Hidden) - YouTube API will convert this div to iframe -->
    <div id="bgMusicPlayer" style="position: absolute; left: -9999px; width: 1px; height: 1px;"></div>

    <!-- üöÄ Futuristic Boost Bar for Hoverboard (CSS in Main.css) -->
    <div id="boostBarContainer" style="display: none;">
        <div class="boost-bar-wrapper">
            <div class="boost-bar-glow"></div>
            <div class="boost-bar-outer">
                <div class="boost-bar-inner" id="boostBarFill"></div>
                <div class="boost-bar-particles"></div>
            </div>
            <div class="boost-bar-label">BOOST</div>
            <div class="boost-bar-percentage" id="boostPercentage">100%</div>
        </div>
    </div>

    <!-- üè™ STORE MANAGEMENT MENU -->
    <div id="management-container" style="display: none;">
        <div class="management-panel">
            <div class="management-header">
                <div class="header-left">
                    <h1 id="store-title">Store Management</h1>
                </div>
                <button class="close-btn" id="close-management">X</button>
            </div>
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="pricing">Custom Pricing</button>
                <button class="tab-btn" data-tab="hours">Store Hours</button>
                <button class="tab-btn" data-tab="sell">Sell Store</button>
            </div>
            <div class="tab-content-wrapper">
                <div class="tab-content active" id="pricing-tab">
                    <div class="section-header">
                        <h2>Set Custom Prices</h2>
                        <p>Customize prices for items sold at your store.</p>
                    </div>
                    <div class="pricing-sections">
                        <!-- Skateboard: Has Styles AND Parts -->
                        <div class="pricing-category">
                            <h3>Skateboard Parts</h3>
                            <div class="pricing-grid">
                                <div class="price-item">
                                    <label>Deck (Modern)</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-skateboard-deck-modern" placeholder="Default" min="0"></div>
                                </div>
                                <div class="price-item">
                                    <label>Deck (Classic)</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-skateboard-deck-classic" placeholder="Default" min="0"></div>
                                </div>
                                <div class="price-item">
                                    <label>Trucks (Modern)</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-skateboard-trucks-modern" placeholder="Default" min="0"></div>
                                </div>
                                <div class="price-item">
                                    <label>Trucks (Classic)</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-skateboard-trucks-classic" placeholder="Default" min="0"></div>
                                </div>
                                <div class="price-item">
                                    <label>Wheels (Modern)</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-skateboard-wheels-modern" placeholder="Default" min="0"></div>
                                </div>
                                <div class="price-item">
                                    <label>Wheels (Classic)</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-skateboard-wheels-classic" placeholder="Default" min="0"></div>
                                </div>
                            </div>
                        </div>

                        <!-- BMX: Simple (No Styles, No Parts) -->
                        <div class="pricing-category">
                            <h3>BMX</h3>
                            <div class="pricing-grid">
                                <div class="price-item">
                                    <label>BMX</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-bmx" placeholder="Default" min="0"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Hoverboard: Has Styles (Ultra/Retro) -->
                        <div class="pricing-category">
                            <h3>Hoverboard</h3>
                            <div class="pricing-grid">
                                <div class="price-item">
                                    <label>Hoverboard (Ultra)</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-hoverboard-ultra" placeholder="Default" min="0"></div>
                                </div>
                                <div class="price-item">
                                    <label>Hoverboard (Retro)</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-hoverboard-retro" placeholder="Default" min="0"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Rollers: Has Styles (Modern/Retro) -->
                        <div class="pricing-category">
                            <h3>Rollers</h3>
                            <div class="pricing-grid">
                                <div class="price-item">
                                    <label>Rollers (Modern)</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-rollers-modern" placeholder="Default" min="0"></div>
                                </div>
                                <div class="price-item">
                                    <label>Rollers (Retro)</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-rollers-retro" placeholder="Default" min="0"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Scooter: Simple (No Styles, No Parts) -->
                        <div class="pricing-category">
                            <h3>Scooter</h3>
                            <div class="pricing-grid">
                                <div class="price-item">
                                    <label>Scooter</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-scooter" placeholder="Default" min="0"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Ski: Simple (No Styles, No Parts) -->
                        <div class="pricing-category">
                            <h3>Ski</h3>
                            <div class="pricing-grid">
                                <div class="price-item">
                                    <label>Ski</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-ski" placeholder="Default" min="0"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Ice Skates: Simple (No Styles, No Parts) -->
                        <div class="pricing-category">
                            <h3>Ice Skates</h3>
                            <div class="pricing-grid">
                                <div class="price-item">
                                    <label>Ice Skates</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-iceskates" placeholder="Default" min="0"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Snowboard: Simple (No Styles, No Parts) -->
                        <div class="pricing-category">
                            <h3>Snowboard</h3>
                            <div class="pricing-grid">
                                <div class="price-item">
                                    <label>Snowboard</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-snowboard" placeholder="Default" min="0"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Equipment: Protection Gear -->
                        <div class="pricing-category equipment-pricing">
                            <h3>Equipment (Protection Gear)</h3>
                            <div class="pricing-grid">
                                <div class="price-item">
                                    <label>Helmet</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-equipment-helmet" placeholder="Default: $5,000" min="0"></div>
                                </div>
                                <div class="price-item">
                                    <label>Forearms</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-equipment-forearms" placeholder="Default: $3,500" min="0"></div>
                                </div>
                                <div class="price-item">
                                    <label>Shin Guards</label>
                                    <div class="input-group"><span class="currency">$</span><input type="number" id="price-equipment-shinguards" placeholder="Default: $3,500" min="0"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="save-pricing">Save Pricing</button>
                        <button class="btn btn-secondary" id="reset-pricing">Reset to Defaults</button>
                    </div>
                </div>
                <div class="tab-content" id="hours-tab">
                    <div class="section-header">
                        <h2>Store Operating Hours</h2>
                        <p>Set when your store is open for business.</p>
                    </div>
                    <div class="hours-section">
                        <div class="hours-input-group">
                            <div class="time-input">
                                <label>Opening Hour</label>
                                <select id="open-hour">
                                    <option value="0">12:00 AM</option>
                                    <option value="1">1:00 AM</option>
                                    <option value="2">2:00 AM</option>
                                    <option value="3">3:00 AM</option>
                                    <option value="4">4:00 AM</option>
                                    <option value="5">5:00 AM</option>
                                    <option value="6">6:00 AM</option>
                                    <option value="7">7:00 AM</option>
                                    <option value="8" selected>8:00 AM</option>
                                    <option value="9">9:00 AM</option>
                                    <option value="10">10:00 AM</option>
                                    <option value="11">11:00 AM</option>
                                    <option value="12">12:00 PM</option>
                                    <option value="13">1:00 PM</option>
                                    <option value="14">2:00 PM</option>
                                    <option value="15">3:00 PM</option>
                                    <option value="16">4:00 PM</option>
                                    <option value="17">5:00 PM</option>
                                    <option value="18">6:00 PM</option>
                                    <option value="19">7:00 PM</option>
                                    <option value="20">8:00 PM</option>
                                    <option value="21">9:00 PM</option>
                                    <option value="22">10:00 PM</option>
                                    <option value="23">11:00 PM</option>
                                </select>
                            </div>
                            <div class="time-separator">‚Üí</div>
                            <div class="time-input">
                                <label>Closing Hour</label>
                                <select id="close-hour">
                                    <option value="1">1:00 AM</option>
                                    <option value="2">2:00 AM</option>
                                    <option value="3">3:00 AM</option>
                                    <option value="4">4:00 AM</option>
                                    <option value="5">5:00 AM</option>
                                    <option value="6">6:00 AM</option>
                                    <option value="7">7:00 AM</option>
                                    <option value="8">8:00 AM</option>
                                    <option value="9">9:00 AM</option>
                                    <option value="10">10:00 AM</option>
                                    <option value="11">11:00 AM</option>
                                    <option value="12">12:00 PM</option>
                                    <option value="13">1:00 PM</option>
                                    <option value="14">2:00 PM</option>
                                    <option value="15">3:00 PM</option>
                                    <option value="16">4:00 PM</option>
                                    <option value="17">5:00 PM</option>
                                    <option value="18">6:00 PM</option>
                                    <option value="19">7:00 PM</option>
                                    <option value="20">8:00 PM</option>
                                    <option value="21">9:00 PM</option>
                                    <option value="22" selected>10:00 PM</option>
                                    <option value="23">11:00 PM</option>
                                    <option value="24">12:00 AM</option>
                                </select>
                            </div>
                        </div>
                        <div class="hours-info">
                            <p>Your store will be <strong>open</strong> during the selected hours.</p>
                        </div>
                        <div class="always-open-option">
                            <label class="checkbox-label">
                                <input type="checkbox" id="always-open">
                                <span>Always Open (24/7)</span>
                            </label>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="save-hours">Save Hours</button>
                    </div>
                </div>
                <div class="tab-content" id="sell-tab">
                    <div class="section-header">
                        <h2>Sell Your Store</h2>
                        <p>List your store for sale or sell it back to the system.</p>
                    </div>
                    <div class="sell-section">
                        <div class="store-value-info">
                            <div class="info-box">
                                <label>Original Purchase Price</label>
                                <span class="value" id="original-price">$0</span>
                            </div>
                            <div class="info-box">
                                <label>Current Status</label>
                                <span class="value" id="sale-status">Not Listed</span>
                            </div>
                        </div>
                        <div class="sell-options">
                            <div class="sell-option-card" id="list-for-sale-section">
                                <h3>List for Sale</h3>
                                <p>Other players can purchase your store at the price you set.</p>
                                <div class="input-group">
                                    <label>Asking Price</label>
                                    <div class="input-with-currency">
                                        <span class="currency">$</span>
                                        <input type="number" id="sale-price" placeholder="Enter sale price" min="0">
                                    </div>
                                </div>
                                <button class="btn btn-warning" id="list-for-sale">List Store for Sale</button>
                            </div>
                            <div class="sell-option-card" id="sellback-section">
                                <h3>Sell Back to System</h3>
                                <p>Instantly sell your store back for 70% of the original purchase price.</p>
                                <div class="sellback-value">
                                    <label>You will receive:</label>
                                    <span class="value" id="sellback-amount">$0</span>
                                </div>
                                <button class="btn btn-danger" id="sellback-store">Sell Back Store</button>
                            </div>
                        </div>
                        <div class="cancel-sale-section" id="cancel-sale-section" style="display: none;">
                            <p style="margin-bottom: 10px; color: #ffd700;">Your store is currently listed for sale.</p>
                            <button class="btn btn-secondary" id="cancel-sale">Cancel Sale Listing</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script> //------------------------------------------------------____________________JavaScript___________________________-----------------------------------------------------------------------
        let currentPage = "container"; // Track the current page
        let availableCategories = []; // Store available categories
        let currentCategory = null; // Currently selected category
        let currentStyle = null; // Currently selected style
        let selectedItems = {}; // Selected items for purchase
        let bgMusicConfig = null; // Background music configuration
        let currentMusicVideo = null; // Current playing music video ID
        let ytPlayer = null; // YouTube player instance
        let isYouTubeAPIReady = false; // Track if YouTube API is loaded
        let pendingMusicInit = false; // Track if we're waiting to init music
        let currentMusicVolume = 0; // Store current volume for when songs change
        let debugMode = false; // Debug mode (set by Lua Config.Debug)
        let musicRetryCount = 0; // Track YouTube API retry attempts
        const MAX_MUSIC_RETRIES = 10; // Maximum retry attempts before giving up

        // Debug console wrapper - only logs when debugMode is enabled
        const debugLog = (...args) => { if (debugMode) console.log(...args); };
        const debugWarn = (...args) => { if (debugMode) console.warn(...args); };
        const debugError = (...args) => { if (debugMode) console.error(...args); };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üí∞ CUSTOM PRICING SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        /**
         * Get custom price for an item if it exists, otherwise return default price
         * @param {string} category - Category name (e.g., "skateboard", "bmx", "hoverboard")
         * @param {string|null} itemType - Item type for multi-part items (e.g., "deck", "trucks", "wheels")
         * @param {string|null} style - Style for styled items (e.g., "modern", "classic", "ultra", "retro")
         * @param {number} defaultPrice - Default price from config
         * @returns {number} Custom price if found, otherwise default price
         */
        function getCustomPrice(category, itemType, style, defaultPrice) {
            if (!window.storeCustomPrices || window.storeCustomPrices.length === 0) {
                return defaultPrice;
            }

            // Search for matching custom price
            for (let i = 0; i < window.storeCustomPrices.length; i++) {
                const customPrice = window.storeCustomPrices[i];

                // Match category
                if (customPrice.category !== category) continue;

                // Match item_type (both null or both equal)
                if ((customPrice.item_type || null) !== (itemType || null)) continue;

                // Match style (both null or both equal)
                if ((customPrice.style || null) !== (style || null)) continue;

                // Found a match!
                debugLog("üí∞ Custom price found:", category, itemType, style, "= $" + customPrice.price, "(default: $" + defaultPrice + ")");
                return customPrice.price;
            }

            return defaultPrice;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üíé PURCHASE TRACKING SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let ownedDesigns = {}; // Stores owned designs: { "category_style": [texture_id1, texture_id2, ...] }
        let equippedDesigns = {}; // Stores equipped design: { "category_style": texture_id }
        let purchaseDataLoaded = {}; // Tracks which categories have loaded purchase data: { "category_style": true }
        let purchaseLoadPromises = {}; // Stores promises for pending purchase loads: { "category_style": Promise }

        // ‚úÖ Helper function to request purchases and return a Promise
        function requestPurchases(itemType, gender) {
            const key = `${itemType}_${gender}`;

            // If already loaded, return resolved promise
            if (purchaseDataLoaded[key]) {
                debugLog(`‚úÖ Purchase data already loaded for ${key}`);
                return Promise.resolve();
            }

            // If request is already pending, return existing promise
            if (purchaseLoadPromises[key]) {
                debugLog(`‚è≥ Purchase request already pending for ${key}, reusing promise`);
                return purchaseLoadPromises[key];
            }

            // Create new promise for this request
            debugLog(`üì° Creating new purchase request promise for ${key}`);
            const promise = new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    debugWarn(`‚ö†Ô∏è Purchase request timeout for ${key} after 2000ms`);
                    resolve(); // Resolve anyway to prevent blocking (fail gracefully)
                }, 2000); // 2 second timeout

                // Store resolve/reject handlers for this key
                if (!window.purchasePromiseHandlers) {
                    window.purchasePromiseHandlers = {};
                }
                window.purchasePromiseHandlers[key] = { resolve, reject, timeout };
            });

            // Store promise before making request
            purchaseLoadPromises[key] = promise;

            // Make the actual fetch request
            fetch(`https://${GetParentResourceName()}/getAllPurchases`, {
                method: "POST",
                body: JSON.stringify({ itemType, gender })
            }).catch(error => {
                debugError(`Failed to request purchases for ${key}:`, error);
                // Resolve anyway on fetch error (fail gracefully)
                if (window.purchasePromiseHandlers && window.purchasePromiseHandlers[key]) {
                    clearTimeout(window.purchasePromiseHandlers[key].timeout);
                    window.purchasePromiseHandlers[key].resolve();
                    delete window.purchasePromiseHandlers[key];
                }
            });

            return promise;
        }

        // YouTube IFrame API Ready Callback
        window.onYouTubeIframeAPIReady = function() {
            console.log("‚úÖ YouTube IFrame API Ready!");
            debugLog("‚úÖ YouTube IFrame API Ready!");
            isYouTubeAPIReady = true;
            // Music will be initialized when server sends sync event
        };

        // Timeout check for YouTube API
        setTimeout(function() {
            if (!isYouTubeAPIReady) {
                console.warn("‚ö†Ô∏è YouTube API did not load within 10 seconds. Background music will be disabled.");
                console.warn("This may be due to:");
                console.warn("1. No internet connection");
                console.warn("2. YouTube is blocked/unavailable");
                console.warn("3. Browser/FiveM CEF restrictions");
            }
        }, 10000);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üîä SOUND SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Play select sound (hover)
        function playSelectSound() {
            const sound = document.getElementById("selectSound");
            if (sound) {
                sound.currentTime = 0;
                sound.volume = 0.4;
                sound.play().catch(e => debugLog("Sound play prevented:", e));
            }
        }

        // Play click sound
        function playClickSound() {
            const sound = document.getElementById("clickSound");
            if (sound) {
                sound.currentTime = 0;
                sound.volume = 0.5;
                sound.play().catch(e => debugLog("Sound play prevented:", e));
            }
        }

        // Add sound effects to all buttons
        function addSoundEffectsToButtons() {
            const allButtons = document.querySelectorAll('button, .menu-item');

            allButtons.forEach(button => {
                // Remove existing listeners to avoid duplicates
                button.removeEventListener('mouseenter', playSelectSound);
                button.removeEventListener('click', playClickSound);

                // Add new listeners
                button.addEventListener('mouseenter', playSelectSound);
                button.addEventListener('click', playClickSound);
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üéµ BACKGROUND MUSIC SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Extract YouTube video ID from URL or return as-is if already an ID
        function extractYouTubeID(urlOrId) {
            // If it's already just an ID (11 characters, no special chars), return it
            if (urlOrId && urlOrId.length === 11 && !urlOrId.includes('/') && !urlOrId.includes('?')) {
                debugLog("Already video ID:", urlOrId);
                return urlOrId;
            }

            // Extract from full URL (supports both youtube.com and music.youtube.com)
            const regExp = /^.*(youtu\.?be.*\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = urlOrId.match(regExp);

            if (match && match[2].length === 11) {
                debugLog("Extracted video ID:", match[2], "from:", urlOrId);
                return match[2];
            }

            debugWarn("Failed to extract video ID from:", urlOrId);
            // If extraction failed, return original (fallback)
            return urlOrId;
        }


        // Start synced music at specific playback position (server-controlled)
        function startSyncedMusic(songUrl, startPositionSeconds) {
            debugLog("üéµ startSyncedMusic called");
            debugLog("Song URL:", songUrl);
            debugLog("Start Position:", startPositionSeconds, "seconds");
            debugLog("API Ready:", isYouTubeAPIReady);

            // Wait for YouTube API to be ready
            if (!isYouTubeAPIReady) {
                if (musicRetryCount >= MAX_MUSIC_RETRIES) {
                    debugWarn("‚ùå YouTube API failed to load after", MAX_MUSIC_RETRIES, "attempts. Music disabled.");
                    return;
                }
                musicRetryCount++;
                if (musicRetryCount === 1 || musicRetryCount % 5 === 0) {
                    debugLog("‚è≥ YouTube API not ready yet, retry", musicRetryCount + "/" + MAX_MUSIC_RETRIES);
                }
                setTimeout(() => startSyncedMusic(songUrl, startPositionSeconds + 1), 1000);
                return;
            }

            // API is ready, reset retry counter
            musicRetryCount = 0;

            // Extract video ID from URL
            const videoId = extractYouTubeID(songUrl);
            debugLog("üé¨ Video ID:", videoId);

            try {
                if (ytPlayer && ytPlayer.loadVideoById) {
                    // Player exists, load new video at correct position
                    debugLog("üìº Loading new video in existing player...");

                    // ‚úÖ CRITICAL: Mute AND set volume to 0 BEFORE loading to prevent audio burst
                    ytPlayer.mute();
                    ytPlayer.setVolume(0);

                    ytPlayer.loadVideoById({
                        videoId: videoId,
                        startSeconds: Math.max(0, startPositionSeconds) // Don't allow negative
                    });

                    // ‚úÖ Keep muted! Do NOT unmute here - let updateMusicVolume handle it
                    // Only the proximity volume update should unmute when volume > 0
                    debugLog("üîá Player MUTED at 0% volume - proximity will unmute when near store");
                    currentMusicVideo = videoId;

                    // Get duration after video loads (wait a bit for metadata to load)
                    setTimeout(() => {
                        if (ytPlayer && ytPlayer.getDuration) {
                            const duration = ytPlayer.getDuration();
                            if (duration && duration > 0) {
                                debugLog("üéµ Song duration:", duration, "seconds");
                                fetch(`https://${GetParentResourceName()}/updateSongDuration`, {
                                    method: "POST",
                                    body: JSON.stringify({ duration: Math.floor(duration) })
                                }).catch(e => debugLog("Duration update sent"));
                            }
                        }
                    }, 1000);

                    // Request fresh volume update from Lua to ensure correct volume
                    fetch(`https://${GetParentResourceName()}/requestVolumeUpdate`, {
                        method: "POST"
                    }).catch(e => debugLog("Volume update request sent"));
                } else {
                    // Create new player
                    debugLog("üé¨ Creating new YouTube player...");
                    ytPlayer = new YT.Player('bgMusicPlayer', {
                        height: '0',
                        width: '0',
                        videoId: videoId,
                        playerVars: {
                            autoplay: 0, // ‚úÖ NO autoplay - we control when to play
                            start: Math.max(0, startPositionSeconds), // Start at synced position
                            controls: 0,
                            disablekb: 1,
                            fs: 0,
                            modestbranding: 1,
                            playsinline: 1,
                            rel: 0
                        },
                        events: {
                            onReady: function(event) {
                                debugLog("‚úÖ YouTube player ready!");

                                // ‚úÖ CRITICAL: Do NOT play yet! Only prepare the player.
                                // The video will start playing when updateMusicVolume receives volume > 0
                                // This prevents ANY audio burst on resource start
                                event.target.setVolume(0);
                                event.target.mute(); // Extra safety - mute until needed
                                debugLog("üîá Player prepared but NOT playing - waiting for proximity");
                                // Video stays paused/cued - will play only when near a store
                            },
                            onStateChange: function(event) {
                                debugLog("üéµ Player state changed:", event.data);

                                // When video starts playing, send duration to server for sync
                                if (event.data === 1) { // YT.PlayerState.PLAYING
                                    // ‚úÖ CRITICAL: Ensure player respects currentMusicVolume on state change
                                    // This prevents audio burst when songs change
                                    if (currentMusicVolume === 0 || currentMusicVolume === undefined) {
                                        debugLog("üîá Song started but volume is 0 - keeping muted");
                                        event.target.mute();
                                        event.target.setVolume(0);
                                    } else {
                                        // Apply current volume when starting to play
                                        event.target.setVolume(currentMusicVolume);
                                        event.target.unMute();
                                        debugLog("üîä Song started at volume:", currentMusicVolume + "%");
                                    }

                                    const duration = event.target.getDuration();
                                    if (duration && duration > 0) {
                                        debugLog("üéµ Song duration:", duration, "seconds");
                                        fetch(`https://${GetParentResourceName()}/updateSongDuration`, {
                                            method: "POST",
                                            body: JSON.stringify({ duration: Math.floor(duration) })
                                        }).catch(e => debugLog("Duration update sent"));
                                    }
                                }

                                // If video ended, notify server
                                if (event.data === 0) { // YT.PlayerState.ENDED
                                    debugLog("üéµ Song ended naturally");
                                }
                            },
                            onError: function(event) {
                                debugError("‚ùå YouTube player error:", event.data);
                            }
                        }
                    });
                    currentMusicVideo = videoId;
                }
            } catch (error) {
                debugError("‚ùå Error creating/updating YouTube player:", error);
            }
        }

        // ‚úÖ Open menuBox when user clicks "GEAR"
        document.getElementById("openMenuBox").addEventListener("click", function () {
            playClickSound();
            loadAvailableCategories(); // Load categories dynamically
            document.getElementById("menuBox").style.display = "block";
            document.getElementById("firstPage").style.display = "block";
            document.getElementById("container").style.display = "none";
        });

        // ‚úÖ Open Equipment Menu when user clicks "EQUIPMENT"
        const equipmentBtn = document.getElementById("openEquipmentMenu");
        if (equipmentBtn) {
            equipmentBtn.addEventListener("click", function () {
                playClickSound();
                // Notify client to open equipment menu
                fetch(`https://${GetParentResourceName()}/openEquipmentFromMenu`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({})
                }).then(response => response.json())
                  .then(data => {
                      console.log("Equipment menu open request sent to client");
                  })
                  .catch(err => console.error("Error opening equipment menu:", err));
            });
        }

        //-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        document.addEventListener("DOMContentLoaded", function () {
            let closeBtn = document.getElementById("closeContainerNew");

            if (closeBtn) {
                closeBtn.addEventListener("click", function () {
                    document.getElementById("container").style.display = "none"; // Hide the container
                    // Music continues playing in background (proximity-based volume)
                    fetch(`https://${GetParentResourceName()}/closeMenu`, { method: "POST" });
                });
            }

            // Add sound effects to all buttons on page load
            addSoundEffectsToButtons();
        });
        document.addEventListener("DOMContentLoaded", function () {
            fetch(`https://${GetParentResourceName()}/getLanguage`, { method: "POST" })
                .then(response => response.json())
                .then(language => {
                    // Safely set text only if elements exist
                    const equipmentBtn = document.getElementById("equipmentBtn");
                    const gearBtn = document.getElementById("gearBtn");
                    const whatsNewBtn = document.getElementById("whatsNewBtn");
                    const purchaseBtn = document.getElementById("purchaseBtn");

                    if (equipmentBtn) equipmentBtn.innerText = language.equipment;
                    if (gearBtn) gearBtn.innerText = language.gear;
                    if (whatsNewBtn) whatsNewBtn.innerText = language.whats_new;
                    if (purchaseBtn) {
                        purchaseBtn.innerText = language.purchase;
                        // ‚úÖ Disable by default
                        purchaseBtn.disabled = true;
                        purchaseBtn.style.opacity = "0.5";
                        purchaseBtn.style.cursor = "not-allowed";
                    }
                })
                .catch(error => debugError("Failed to load translations:", error));
        });


        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üé® FEATURE IMAGES RANDOMIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const featureImages = [
            'images/features/bmx.jpg',
            'images/features/hoverboard.jpg',
            'images/features/iceskate.jpg',
            'images/features/rollers.jpg',
            'images/features/scooter.jpg',
            'images/features/skate.jpg',
            'images/features/ski.jpg',
            'images/features/snowboard.jpg'
        ];

        function getRandomFeatureImages() {
            // Shuffle and pick 3 unique images
            const shuffled = [...featureImages].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, 3);
        }

        function updateFeatureImages() {
            const featureImgs = document.querySelectorAll('.feature-img');
            const randomImages = getRandomFeatureImages();

            featureImgs.forEach((img, index) => {
                if (randomImages[index]) {
                    img.src = randomImages[index];
                    img.alt = `Feature ${index + 1}`;
                }
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üìñ DISCOVER PAGE HANDLERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.addEventListener("DOMContentLoaded", function () {
            const openDiscoverButton = document.getElementById("openModal");
            const closeDiscoverButton = document.getElementById("closeDiscover");
            const discoverPage = document.getElementById("discoverPage");

            // Randomize feature images on page load
            updateFeatureImages();

            if (openDiscoverButton) {
                openDiscoverButton.addEventListener("click", function () {
                    discoverPage.style.display = "flex";
                    // Randomize images each time discover is opened
                    updateFeatureImages();
                    // Load VIP price
                    loadDiscoverVipPrice();
                });
            }

            if (closeDiscoverButton) {
                closeDiscoverButton.addEventListener("click", function () {
                    discoverPage.style.display = "none";
                });
            }

            // Close discover page if clicking outside
            discoverPage.addEventListener("click", function (event) {
                if (event.target === discoverPage) {
                    discoverPage.style.display = "none";
                }
            });

            // VIP Purchase button in Discover page - Opens Tebex link
            const discoverVipBtn = document.getElementById("discoverVipPurchase");
            if (discoverVipBtn) {
                discoverVipBtn.addEventListener("click", function () {
                    // Don't open store if already owned
                    if (discoverVipBtn.classList.contains("owned")) {
                        return;
                    }
                    // Open Tebex package link
                    fetch(`https://${GetParentResourceName()}/openNeoXtremeStore`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({})
                    }).catch(err => console.error("Tebex open error:", err));
                });
            }
        });

        // Update Discover page VIP button state
        const NEO_PACK_ID = "7139397";

        function updateDiscoverButtonState(ownsNeoPack) {
            const btn = document.getElementById("discoverVipPurchase");
            const btnText = btn?.querySelector(".btn-text");
            const btnPrice = btn?.querySelector(".btn-price");

            if (!btn) return;

            console.log("[Discover] Updating button state - owned:", ownsNeoPack);

            if (ownsNeoPack) {
                // Player owns the pack - show green OWNED state
                btn.classList.add("owned");
                if (btnText) btnText.textContent = "OWNED ‚úì";
                if (btnPrice) btnPrice.style.display = "none";
                btn.disabled = true;
                btn.style.cursor = "default";
            } else {
                // Player doesn't own - reset to purchase state
                btn.classList.remove("owned");
                if (btnText) btnText.textContent = "GET NEO XTREME";
                if (btnPrice) btnPrice.style.display = "block";
                btn.disabled = false;
                btn.style.cursor = "pointer";
            }
        }

        // Load VIP status for discover page
        function loadDiscoverVipPrice() {
            // First check cached EquipmentState (fast path)
            const cachedOwns = typeof EquipmentState !== 'undefined' &&
                               EquipmentState.ownedPackages &&
                               EquipmentState.ownedPackages.length > 0 &&
                               (EquipmentState.ownedPackages.includes(NEO_PACK_ID) ||
                                EquipmentState.ownedPackages.includes(parseInt(NEO_PACK_ID)));

            if (cachedOwns) {
                console.log("[Discover] Using cached ownership - owned");
                updateDiscoverButtonState(true);
                return;
            }

            console.log("[Discover] Requesting fresh ownership check from server...");

            // Request fresh data from server - result will come via SendNUIMessage
            fetch(`https://${GetParentResourceName()}/checkPackageOwnership`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ packageId: NEO_PACK_ID })
            })
            .then(response => response.json())
            .then(data => {
                console.log("[Discover] Fetch response:", data);
                // Note: result will come via packageOwnershipResult message
            })
            .catch(err => {
                console.log("[Discover] Package ownership check failed:", err);
            });
        }

        // Listen for package ownership result from Lua
        window.addEventListener("message", function(event) {
            if (event.data.action === "packageOwnershipResult") {
                console.log("[Discover] Received packageOwnershipResult:", event.data);
                if (event.data.packageId === NEO_PACK_ID) {
                    updateDiscoverButtonState(event.data.owned === true);
                    // Update cache
                    if (event.data.owned && typeof EquipmentState !== 'undefined') {
                        if (!EquipmentState.ownedPackages) EquipmentState.ownedPackages = [];
                        if (!EquipmentState.ownedPackages.includes(NEO_PACK_ID)) {
                            EquipmentState.ownedPackages.push(NEO_PACK_ID);
                        }
                    }
                }
            }
        });

        document.addEventListener("keydown", function (event) {
            let discoverPage = document.getElementById("discoverPage");

            if (event.code === "Space" && discoverPage.style.display !== "flex") {
                event.preventDefault();
            }
        });

        //--------------------------------------------------------------------------------------------------------------------------------------------------
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üîß UNIFIED STORE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Load language strings from Lua
        function loadLanguageStrings() {
            fetch(`https://${GetParentResourceName()}/getLanguage`, { method: "POST" })
                .then(response => response.json())
                .then(language => {
                    // Update purchase button if it exists
                    const purchaseBtn = document.getElementById("purchaseBtn");
                    if (purchaseBtn && language.purchase) {
                        purchaseBtn.innerText = language.purchase;
                        // ‚úÖ Disable by default
                        purchaseBtn.disabled = true;
                        purchaseBtn.style.opacity = "0.5";
                        purchaseBtn.style.cursor = "not-allowed";
                    }
                })
                .catch(error => debugError("Failed to load language strings:", error));
        }

        // Load available categories from Lua
        function loadAvailableCategories() {
            fetch(`https://${GetParentResourceName()}/getAvailableCategories`, {
                method: "POST"
            })
                .then(response => response.json())
                .then(data => {
                    availableCategories = data.categories || [];
                    displayCategories();

                    // ‚úÖ Request owned purchases for ALL categories when menu opens
                    debugLog("üîì Menu opened - requesting owned purchases for all categories...");
                    availableCategories.forEach(category => {
                        if (category.styles && Array.isArray(category.styles)) {
                            category.styles.forEach(style => {
                                requestPurchases(category.id, style);
                            });
                        }
                    });
                })
                .catch(error => debugError("Failed to load categories:", error));
        }

        // Display categories on firstPage
        function displayCategories() {
            const container = document.getElementById("categoryButtons");
            // Clear existing buttons except back arrow
            const backArrow = container.querySelector(".back-arrow");
            container.innerHTML = "";

            if (availableCategories.length === 0) {
                const noGearMsg = document.createElement("p");
                noGearMsg.style.color = "white";
                noGearMsg.innerText = "No gear available";
                container.appendChild(noGearMsg);
            } else {
                availableCategories.forEach(category => {
                    const btn = document.createElement("button");
                    btn.className = "words-style category-button";
                    btn.setAttribute("data-category", category.id);
                    btn.id = `category-btn-${category.id}`; // Add ID for position tracking
                    // Dynamically set icon from config
                    if (category.icon) {
                        btn.style.setProperty('--category-icon', `url('${category.icon}')`);
                    }
                    btn.innerText = category.displayName;
                    btn.onclick = (event) => selectCategory(category.id, event.currentTarget);
                    container.appendChild(btn);
                });
            }

            // Re-add back arrow at the end
            if (backArrow) {
                container.appendChild(backArrow);
            }

            // Add sound effects to newly created buttons
            addSoundEffectsToButtons();
        }

        // Category selected
        function selectCategory(categoryId, buttonElement) {
            currentCategory = categoryId;

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // üõí CHECK ITEM OWNERSHIP FIRST
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            fetch(`https://${GetParentResourceName()}/checkGearOwnership`, {
                method: "POST",
                body: JSON.stringify({ category: categoryId })
            })
                .then(response => response.json())
                .then(ownershipData => {
                    if (!ownershipData.owned) {
                        // Player doesn't own the item - show purchase prompt with button position
                        showPurchasePrompt(ownershipData, buttonElement);
                    } else {
                        // Player owns the item - proceed to customization
                        proceedToCustomization(categoryId);
                    }
                })
                .catch(error => {
                    debugError("Failed to check ownership:", error);
                    // On error, proceed anyway (fallback)
                    proceedToCustomization(categoryId);
                });
        }

        function proceedToCustomization(categoryId) {
            fetch(`https://${GetParentResourceName()}/categorySelected`, {
                method: "POST",
                body: JSON.stringify({ category: categoryId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.requiresStyle) {
                        // Show style selection
                        displayStyles(data.styles);
                     } else if (data.requiresParts) {
                        // ‚úÖ No style selection needed, but show part selection (for auto-modern when no Classic DLC)
                        currentStyle = "unisex"; // ‚úÖ Set default style for categories without styles
                        displayParts(data.parts);
                        document.getElementById("firstPage").style.display = "none";
                        document.getElementById("mainMenu").style.display = "block";
                        currentPage = "mainMenu";
                    } else {
                        // No style or parts needed, show designs directly
                        // ‚úÖ For sex-based categories (ice skates), use the gender returned by server
                        // ‚úÖ For regular categories (BMX, Scooter, Ski), use "unisex"
                        currentStyle = data.gender || "unisex";

                        if (data.gender) {
                            debugLog(`‚úÖ Sex-based category detected, currentStyle set to: ${data.gender}`);
                        }

                        document.getElementById("firstPage").style.display = "none";
                        document.getElementById("mainMenu").style.display = "none";
                        showDesignSelection();
                    }
                })
                .catch(error => debugError("Failed to select category:", error));
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üõí PURCHASE PROMPT MODAL HANDLERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showPurchasePrompt(data, sourceButton) {
            const modal = document.getElementById("purchasePromptModal");
            const modalContent = modal.querySelector(".purchase-prompt-content");
            const titleEl = document.getElementById("purchasePromptTitle");
            const messageEl = document.getElementById("purchasePromptMessage");

            titleEl.textContent = data.title || "Purchase Required";
            messageEl.textContent = data.message || `You need to purchase ${data.itemName} first ($${data.price})`;

            // Store the source button reference for later use
            modal.dataset.sourceButtonId = sourceButton ? sourceButton.id : null;

            // Get button position for animation
            if (sourceButton) {
                const rect = sourceButton.getBoundingClientRect();
                const buttonCenterX = rect.left + rect.width / 2;
                const buttonCenterY = rect.top + rect.height / 2;

                // Set CSS custom properties for animation origin
                modalContent.style.setProperty('--origin-x', `${buttonCenterX}px`);
                modalContent.style.setProperty('--origin-y', `${buttonCenterY}px`);

                // Position element at button BEFORE showing it (prevent teleport)
                modalContent.style.left = `${buttonCenterX}px`;
                modalContent.style.top = `${buttonCenterY}px`;
                modalContent.style.transform = 'translateY(-50%) scale(0)';
                modalContent.style.opacity = '0';

                // ‚úÖ Gray out all other category buttons except the selected one
                document.querySelectorAll('.category-button').forEach(btn => {
                    if (btn !== sourceButton) {
                        btn.classList.add('disabled-button');
                        btn.style.pointerEvents = 'none';
                    } else {
                        // Selected button stays colored but unclickable
                        btn.style.pointerEvents = 'none';
                    }
                });
            }

            // Show modal (block, not flex - we position manually)
            modal.style.display = "block";

            // Trigger animation after a tiny delay to ensure initial position is set
            setTimeout(() => {
                if (sourceButton) {
                    modalContent.classList.add('slide-from-button');
                }
            }, 10);

            // Store data for purchase
            modal.dataset.category = data.category;
            modal.dataset.price = data.price;
            modal.dataset.itemName = data.itemName;

            // ‚úÖ Apply final position as inline styles before removing animation class
            // This keeps the bubble visible at its final position
            setTimeout(() => {
                if (modalContent) {
                    const rect = sourceButton ? sourceButton.getBoundingClientRect() : null;
                    if (rect) {
                        const buttonCenterX = rect.left + rect.width / 2;
                        const buttonCenterY = rect.top + rect.height / 2;

                        // Apply final animated position as inline styles
                        modalContent.style.left = `${buttonCenterX + 80}px`;
                        modalContent.style.top = `${buttonCenterY}px`;
                        modalContent.style.transform = 'translateY(-50%) scale(1)';
                        modalContent.style.opacity = '1';
                    }

                    // Now safe to remove animation class
                    modalContent.classList.remove('slide-from-button');
                }
            }, 400);
        }

        function hidePurchasePrompt() {
            const modal = document.getElementById("purchasePromptModal");
            const modalContent = modal.querySelector(".purchase-prompt-content");

            // Add slide-out animation
            modalContent.classList.add('slide-to-button');

            // ‚úÖ Re-enable all category buttons
            document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('disabled-button');
                btn.style.pointerEvents = 'auto';
            });

            // Wait for animation to complete before hiding
            setTimeout(() => {
                modal.style.display = "none";
                modalContent.classList.remove('slide-to-button');
            }, 300);
        }

        // Yes button - purchase the base item
        document.getElementById("purchasePromptYes").addEventListener("click", function() {
            const modal = document.getElementById("purchasePromptModal");
            const category = modal.dataset.category;
            const price = parseInt(modal.dataset.price);

            // Send purchase request to Lua
            fetch(`https://${GetParentResourceName()}/purchaseBaseItem`, {
                method: "POST",
                body: JSON.stringify({
                    category: category,
                    price: price
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Purchase successful - hide modal and proceed to customization
                        hidePurchasePrompt();
                        proceedToCustomization(category);
                    } else {
                        // Purchase failed - hide modal (notification handled by Lua)
                        hidePurchasePrompt();
                    }
                })
                .catch(error => {
                    debugError("Failed to purchase base item:", error);
                    hidePurchasePrompt();
                });
        });

        // No button - go back
        document.getElementById("purchasePromptNo").addEventListener("click", function() {
            hidePurchasePrompt();
        });

        // Display styles (modern/classic or ultra/retro)
        function displayStyles(styles) {
            const container = document.getElementById("mainMenuButtons");
            const backArrow = container.querySelector(".back-arrow");
            container.innerHTML = "";

            styles.forEach(style => {
                const btn = document.createElement("button");
                btn.className = "words-style";
                btn.innerText = style.name;
                btn.onclick = () => selectStyle(style.id);
                container.appendChild(btn);
            });

            if (backArrow) {
                container.appendChild(backArrow);
            }

            // Show mainMenu
            document.getElementById("firstPage").style.display = "none";
            document.getElementById("mainMenu").style.display = "block";
            currentPage = "mainMenu";

            // Add sound effects to newly created buttons
            addSoundEffectsToButtons();
        }

        // Style selected
        function selectStyle(styleId) {
            currentStyle = styleId;

            // ‚úÖ Request owned purchases for this category/style
            if (currentCategory && currentStyle) {
                requestPurchases(currentCategory, currentStyle);
            }

            fetch(`https://${GetParentResourceName()}/styleSelected`, {
                method: "POST",
                body: JSON.stringify({ style: styleId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.requiresParts) {
                        // Show parts selection (skateboard)
                        displayParts(data.parts);
                    } else {
                        // Show design selection
                        showDesignSelection(data.count, data.prefix);
                    }
                })
                .catch(error => debugError("Failed to select style:", error));
        }

        // Display parts (deck/trucks/wheels)
        function displayParts(parts) {
            const container = document.getElementById("mainMenuButtons");
            const backArrow = container.querySelector(".back-arrow");
            container.innerHTML = "";

            parts.forEach(part => {
                const btn = document.createElement("button");
                btn.className = "words-style";
                btn.innerText = part.name;
                btn.onclick = () => showSubMenu(part.id); // Let showSubMenu fetch the design count with proper imagePath
                container.appendChild(btn);
            });

            if (backArrow) {
                container.appendChild(backArrow);
            }

            // Add sound effects to newly created buttons
            addSoundEffectsToButtons();

            // mainMenu is already visible
        }

        // Show design selection (for parts or full items)
        function showDesignSelection(count, prefix) {
            // Don't pass parameters to showSubMenu - let it fetch properly
            showSubMenu(null);
        }

        function proceedToMainMenu(type = null) {
            // Legacy function for compatibility
            const payload = type ? JSON.stringify({ boardType: type }) : "{}";

            fetch(`https://${GetParentResourceName()}/proceedToMenu`, {
                method: "POST",
                body: payload
            });
        }

        let designCount = 18; // Default fallback

        // Request Config.DesignCount from Lua
        fetch(`https://${GetParentResourceName()}/getDesignCount`, {
            method: "POST",
        })
            .then(response => response.json())
            .then(data => {
                if (data.designCount) {
                    designCount = data.designCount; // Update the count from Lua
                }
            })
            .catch(error => debugError("Failed to get DesignCount:", error));

        async function showSubMenu(partType = null, count = null, prefix = null, resourceName = null) {
            const options = document.getElementById("options");
            const title = document.getElementById("submenu-title");

            document.getElementById("mainMenu").style.display = "none";
            document.getElementById("subMenu").style.display = "block";
            currentPage = "subMenu";

            title.innerText = partType ? partType.charAt(0).toUpperCase() + partType.slice(1) : "Select Design";
            options.innerHTML = "";

            // ‚úÖ Show rotation controls only if category supports rotation
            const rotationControls = document.getElementById("rotationControls");
            if (rotationControls) {
                const categoryData = availableCategories.find(cat => cat.id === currentCategory);
                const canRotate = categoryData && categoryData.canRotate !== false;
                rotationControls.style.display = canRotate ? "block" : "none";
            }

            // ‚úÖ Disable purchase button by default (will be enabled when item is selected)
            const purchaseBtn = document.getElementById("purchaseBtn");
            if (purchaseBtn) {
                purchaseBtn.disabled = true;
                purchaseBtn.style.opacity = "0.5";
                purchaseBtn.style.cursor = "not-allowed";
            }

            // ‚úÖ Request and WAIT for purchase data before rendering
            if (currentCategory && currentStyle) {
                // ‚úÖ For skateboard parts, request ownership using partType (deck/trucks/wheels) instead of "skateboard"
                const categoryToRequest = partType || currentCategory;
                const purchasePromise = requestPurchases(categoryToRequest, currentStyle);
                debugLog(`‚è≥ Waiting for purchase data for ${categoryToRequest}/${currentStyle}...`);
                try {
                    await purchasePromise;
                    debugLog(`‚úÖ Purchase data ready, proceeding to render`);
                } catch (error) {
                    debugWarn(`‚ö†Ô∏è Purchase data load failed or timed out, rendering anyway:`, error);
                }
            }

            // If count/prefix/resourceName not provided, fetch them
            if (count === null || prefix === null) {
                fetch(`https://${GetParentResourceName()}/getDesignCount`, {
                    method: "POST",
                    body: JSON.stringify({ part: partType, category: currentCategory, style: currentStyle })
                })
                    .then(response => response.json())
                    .then(data => {
                        renderDesignOptions(data.count, data.prefix, data.resourceName, partType, data.imagePath, data.price);
                    })
                    .catch(error => debugError("Failed to get design count:", error));
            } else {
                renderDesignOptions(count, prefix, resourceName || GetParentResourceName(), partType, "", null);
            }
        }

        function renderDesignOptions(count, prefix, resourceName, partType, imagePath, price = null) {
            const options = document.getElementById("options");
            options.innerHTML = "";

            // ‚úÖ Disable purchase button when loading new designs
            const purchaseBtn = document.getElementById("purchaseBtn");
            if (purchaseBtn) {
                purchaseBtn.disabled = true;
                purchaseBtn.style.opacity = "0.5";
                purchaseBtn.style.cursor = "not-allowed";
            }

            debugLog("renderDesignOptions called with:", { count, prefix, resourceName, partType, imagePath, price });

            // ‚úÖ Rollers and Ice Skates use 0-indexed images (0-7), other categories use 1-indexed (1-8)
            const isZeroIndexed = imagePath && (imagePath.includes("rollers") || imagePath.includes("iceskates"));
            const startIndex = isZeroIndexed ? 0 : 1;
            const endIndex = isZeroIndexed ? (count - 1) : count;

            // Check owned designs for this category/style
            // ‚úÖ For skateboard parts, use partType (deck/trucks/wheels) instead of currentCategory
            const categoryForOwnership = partType || currentCategory;
            const key = `${categoryForOwnership}_${currentStyle}`;
            const owned = ownedDesigns[key] || [];
            const ownedTextureIds = owned.map(p => p.texture_id);

            // Find equipped design (handle both boolean and number)
            const equippedDesign = owned.find(p => p.is_equipped === 1 || p.is_equipped === true);
            const equippedTextureId = equippedDesign ? equippedDesign.texture_id : null;

            for (let i = startIndex; i <= endIndex; i++) {
                // Create wrapper div for image + price
                const itemWrapper = document.createElement("div");
                itemWrapper.className = "design-item-wrapper";

                // ‚úÖ Check if this design is owned
                const isOwned = ownedTextureIds.includes(i);
                const isEquipped = (i === equippedTextureId);

                // ‚úÖ Add owned class for blue glow instead of pink
                if (isOwned) {
                    itemWrapper.classList.add("design-owned");
                    debugLog(`üíé Design ${i} is owned`);
                }

                // ‚úÖ Add equipped class for additional styling
                if (isEquipped) {
                    itemWrapper.classList.add("design-equipped");
                    debugLog(`‚ö° Design ${i} is EQUIPPED`);
                }

                const img = document.createElement("img");

                // Construct image path with organized folder structure
                // imagePath already includes category folder + style subfolder if applicable
                let fullPath = `nui://${resourceName}/nui/customs/${imagePath || ""}${prefix}${i}.png`;

                debugLog(`Image ${i} path:`, fullPath);

                img.src = fullPath;
                img.alt = `${partType || 'design'} ${i}`;
                img.setAttribute("data-id", i);
                img.setAttribute("data-type", partType || "design");
                img.setAttribute("data-owned", isOwned ? "true" : "false");
                img.onclick = () => {
                    playClickSound();
                    selectItem(i, partType, itemWrapper, isOwned);
                };
                img.onmouseenter = () => playSelectSound();

                itemWrapper.appendChild(img);

                // Add price label if price is provided (hide for owned items)
                if (!isOwned && price !== null && price !== undefined) {
                    const priceLabel = document.createElement("div");
                    priceLabel.className = "design-price";
                    priceLabel.textContent = `$${price.toLocaleString()}`;
                    itemWrapper.appendChild(priceLabel);
                } else if (isOwned) {
                    // ‚úÖ Show "EQUIPPED" for equipped design, "OWNED" for others
                    if (isEquipped) {
                        const equippedLabel = document.createElement("div");
                        equippedLabel.className = "design-equipped-label";
                        equippedLabel.textContent = "EQUIPPED";
                        itemWrapper.appendChild(equippedLabel);
                    } else {
                        const ownedLabel = document.createElement("div");
                        ownedLabel.className = "design-owned-label";
                        ownedLabel.textContent = "OWNED";
                        itemWrapper.appendChild(ownedLabel);
                    }
                }

                options.appendChild(itemWrapper);
            }

            // Add sound effects to any buttons in the container
            addSoundEffectsToButtons();
        }


        function selectItem(id, partType, element, isOwned = false) {
            // Remove previous selections
            document.querySelectorAll(".selected-item").forEach(item => {
                item.classList.remove("selected-item");
            });

            // Set the selected item
            element.classList.add("selected-item");

            // Store selected item for purchase/equip
            if (partType) {
                selectedItems[partType] = id;
            } else {
                selectedItems.design = id;
            }

            // ‚úÖ Enable purchase button and change text based on ownership
            const purchaseBtn = document.getElementById("purchaseBtn");
            if (purchaseBtn) {
                purchaseBtn.disabled = false;
                purchaseBtn.style.opacity = "1";
                purchaseBtn.style.cursor = "pointer";

                // ‚úÖ Change button text and style based on ownership
                if (isOwned) {
                    purchaseBtn.textContent = "EQUIP";
                    purchaseBtn.setAttribute("data-action", "equip");
                    debugLog(`üíé Selected owned design ${id} - Button set to EQUIP`);
                } else {
                    purchaseBtn.textContent = "PURCHASE";
                    purchaseBtn.setAttribute("data-action", "purchase");
                    debugLog(`üõí Selected new design ${id} - Button set to PURCHASE`);
                }
            }

            // Notify Lua about selection (for preview if needed)
            fetch(`https://${GetParentResourceName()}/itemSelected`, {
                method: "POST",
                body: JSON.stringify({ id: id, part: partType }),
            });
        }

        function purchaseItem() {
            let selectedItem = document.querySelector(".selected-item");
            if (!selectedItem) {
                debugWarn("No item selected");
                return;
            }

            // ‚úÖ Disable purchase button immediately to prevent double-clicks
            const purchaseBtn = document.getElementById("purchaseBtn");
            const action = purchaseBtn ? purchaseBtn.getAttribute("data-action") : "purchase";

            if (purchaseBtn) {
                purchaseBtn.disabled = true;
                purchaseBtn.style.opacity = "0.5";
                purchaseBtn.style.cursor = "not-allowed";
            }

            // ‚úÖ Check if this is an equip action or purchase action
            const isEquip = (action === "equip");

            if (isEquip) {
                debugLog("üíé Equipping owned design (using purchase flow, no charge)...");
            } else {
                // ‚úÖ PURCHASE ACTION (Charge money)
                debugLog("üõí Purchasing new design...");
            }

            // ‚úÖ Convert 0-indexed IDs to 1-indexed for backend (rollers & iceskates)
            let itemsToSend = { ...selectedItems };
            if ((currentCategory === "rollers" || currentCategory === "iceskates") && itemsToSend.design !== undefined) {
                itemsToSend.design = itemsToSend.design + 1;
                debugLog(`Converted ${currentCategory} design ID from ${selectedItems.design} to ${itemsToSend.design}`);
            }

            // ‚úÖ Use SAME purchase endpoint for both purchase and equip
            fetch(`https://${GetParentResourceName()}/purchaseItem`, {
                method: "POST",
                body: JSON.stringify({
                    category: currentCategory,
                    style: currentStyle,
                    items: itemsToSend,
                    isEquip: isEquip  // ‚úÖ Flag to indicate equip (no charge)
                }),
            }).then(resp => resp.json()).then(resp => {
                debugLog(isEquip ? "Equip response:" : "Purchase response:", resp);
                if (resp === "ok") {
                    debugLog(isEquip ? "‚úÖ Design equipped successfully - no charge!" : "‚úÖ Purchase successful!");

                    // ‚úÖ Update local owned designs
                    const key = `${currentCategory}_${currentStyle}`;
                    const textureId = selectedItems.design !== undefined ? selectedItems.design : (selectedItems[Object.keys(selectedItems)[0]] || 0);

                    if (!ownedDesigns[key]) {
                        ownedDesigns[key] = [];
                    }

                    if (!isEquip) {
                        // Only add to owned on purchase, not equip (already owned)
                        ownedDesigns[key].push({ texture_id: textureId, is_equipped: 1 });
                    }
                    equippedDesigns[key] = textureId;

                    debugLog(`üíé ${isEquip ? "Equipped" : "Added to owned designs"}: ${key} - texture_id=${textureId}`);

                    // Clear selection
                    document.querySelectorAll(".selected-item").forEach(item => {
                        item.classList.remove("selected-item");
                    });

                    // ‚úÖ Re-render immediately to show updated status
                    debugLog(`üîÑ Re-rendering designs after ${isEquip ? "equip" : "purchase"}...`);
                    fetch(`https://${GetParentResourceName()}/getDesignCount`, {
                        method: "POST",
                        body: JSON.stringify({ part: null, category: currentCategory, style: currentStyle })
                    })
                        .then(response => response.json())
                            .then(designData => {
                                renderDesignOptions(designData.count, designData.prefix, designData.resourceName, null, designData.imagePath, designData.price);
                                debugLog("‚úÖ Designs re-rendered with ownership status");
                            })
                            .catch(error => debugError("Failed to re-render after purchase:", error));
                    } else {
                        // Re-enable button if purchase failed
                        if (purchaseBtn) {
                            purchaseBtn.disabled = false;
                            purchaseBtn.style.opacity = "1";
                            purchaseBtn.style.cursor = "pointer";
                        }
                    }
                });
        }



        function closeMenu() { //----------------------------------------------------------------------------??????????????-------------------------------------------
            document.getElementById("menuBox").style.display = "none"; // Ocultar men√∫
            document.getElementById("container").style.display = "block"; // Volver a la pantalla principal------------------------?????????????????????--------------------------------
            //fetch(`https://${GetParentResourceName()}/closeMenu`, { method: "POST" });
        }

        function closeMain() { //----------------------------------------------------------------------------??????????????-------------------------------------------
            document.getElementById("menuBox").style.display = "none"; // Ocultar men√∫
            document.getElementById("container").style.display = "none"; // Volver a la pantalla principal------------------------?????????????????????--------------------------------
            fetch(`https://${GetParentResourceName()}/closeMenu`, { method: "POST" });
        }



        // ‚ö†Ô∏è REMOVED: Duplicate onYouTubeIframeAPIReady - was conflicting with background music system
        // Background music system handles YouTube API initialization at line 536

        // Ensure video loads when the modal is opened
        function openVideoModal() {
            document.getElementById("videoModal").style.display = "flex"; // Show modal
            document.getElementById("mainMenu").style.display = "none";  // Hide main menu
            document.getElementById("subMenu").style.display = "none";  // Hide subMenu

            if (youtubePlayer) {
                youtubePlayer.playVideo(); // Play video when modal opens
            }
        }

        // Pause the video when closing the modal
        function closeVideoModal() {
            document.getElementById("videoModal").style.display = "none"; // Hide modal
            document.getElementById("mainMenu").style.display = "block";  // Show main menu

            if (youtubePlayer) {
                youtubePlayer.pauseVideo(); // Pause video without restarting
            }
        }


        function goBack() {
            const subMenu = document.getElementById("subMenu");
            const mainMenu = document.getElementById("mainMenu");
            const firstPage = document.getElementById("firstPage");
            const container = document.getElementById("container");

            // Close the exclusive package popup when navigating
            closeExclusivePopup();

            if (subMenu.style.display === "block") {
                // Going back from design/part selection
                subMenu.style.display = "none";

                // Hide rotation controls when leaving submenu
                const rotationControls = document.getElementById("rotationControls");
                if (rotationControls) {
                    rotationControls.style.display = "none";
                }

                // Check if current category requires styles
                const currentCategoryData = availableCategories.find(cat => cat.id === currentCategory);
                const requiresStyle = currentCategoryData && (currentCategoryData.hasStyles || currentCategoryData.hasParts);

                if (requiresStyle) {
                    // Show style/part selection (mainMenu)
                    mainMenu.style.display = "block";
                    currentPage = "mainMenu";
                } else {
                    // Skip mainMenu, go directly to category selection (firstPage)
                    firstPage.style.display = "block";
                    currentPage = "firstPage";
                    currentCategory = null;
                }

                fetch(`https://${GetParentResourceName()}/goBack`, {
                    method: "POST",
                    body: JSON.stringify({ currentPage: "subMenu" }),
                });

            } else if (mainMenu.style.display === "block") {
                // Going back from style/part selection to category selection
                mainMenu.style.display = "none";
                firstPage.style.display = "block";
                currentPage = "firstPage";
                currentStyle = null;

                fetch(`https://${GetParentResourceName()}/goBack`, {
                    method: "POST",
                    body: JSON.stringify({ currentPage: "mainMenu" }),
                });

            } else if (firstPage.style.display === "block") {
                // Going back from category selection to main container
                firstPage.style.display = "none";
                document.getElementById("menuBox").style.display = "none";
                container.style.display = "block";
                currentPage = "container";
                currentCategory = null;
                currentStyle = null;
                selectedItems = {};

                fetch(`https://${GetParentResourceName()}/goBack`, {
                    method: "POST",
                    body: JSON.stringify({ currentPage: "firstPage" }),
                });
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üîÑ MODEL ROTATION FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let rotationInterval = null;
        let isRotating = false;

        function rotateModel(direction) {
            // Send rotation command to Lua
            fetch(`https://${GetParentResourceName()}/rotateModel`, {
                method: "POST",
                body: JSON.stringify({ direction: direction })
            }).then(response => response.json())
              .then(data => {
                  debugLog(`Model rotated ${direction}`);
              })
              .catch(error => debugError("Failed to rotate model:", error));
        }

        function startRotation(direction) {
            // Prevent multiple rotation intervals
            if (isRotating) return;

            isRotating = true;

            // Play click sound once at start
            playClickSound();

            // Immediate first rotation
            rotateModel(direction);

            // Continue rotating while button is held (every 50ms for smooth rotation)
            rotationInterval = setInterval(() => {
                rotateModel(direction);
            }, 50);
        }

        function stopRotation() {
            if (rotationInterval) {
                clearInterval(rotationInterval);
                rotationInterval = null;
            }
            isRotating = false;
        }


        function sendSkateType(type) {
            fetch(`https://${GetParentResourceName()}/${type}Selected`, {
                method: "POST"
            });
        }

        // Handle NUI Messages
        window.addEventListener("message", (event) => {
            const data = event.data;

            //-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------?????????????
            if (data.action === "syncMusic") {
                // Receive synced music from server
                bgMusicConfig = data.musicConfig;
                debugMode = data.debug || false; // Update debug mode from Lua
                debugLog("üéµ Received music sync from server");
                debugLog("Song URL:", data.songUrl);
                debugLog("Server Start Time:", data.startTime);
                debugLog("Initial Volume:", data.initialVolume ?? "not set");

                // Calculate how many seconds into the song we should be
                const currentTime = Date.now();
                const elapsedMs = currentTime - data.startTime;
                const elapsedSeconds = Math.floor(elapsedMs / 1000);

                debugLog("Current Time:", currentTime);
                debugLog("Elapsed Time:", elapsedSeconds + " seconds");

                // ‚úÖ Set initial volume to 0 (prevents audio glitch on connect/restart)
                if (data.initialVolume !== undefined) {
                    currentMusicVolume = data.initialVolume;
                    debugLog("üîá Initial volume set to:", currentMusicVolume + "% (distance calculation will update)");
                }

                // Start the synced music at the correct position
                startSyncedMusic(data.songUrl, elapsedSeconds);
            } else if (data.action === "updateMusicVolume") {
                // Update volume based on proximity to store
                // Ensure complete silence when volume is 0 or very close to 0
                let volumePercent = Math.round((data.volume || 0) * 100);
                if (data.volume < 0.001) {
                    volumePercent = 0; // Force complete silence for very small values
                }

                // Store current volume for when songs change
                currentMusicVolume = volumePercent;

                debugLog("üîä Volume update request:", volumePercent + "%", volumePercent === 0 ? "(SILENT)" : "");

                if (!ytPlayer) {
                    debugWarn("‚ö†Ô∏è No ytPlayer exists yet! Volume stored for when player loads.");
                    return;
                }

                // Use a safer approach - try/catch with methods
                try {
                    // Check if methods exist before calling
                    if (typeof ytPlayer.setVolume !== 'function') {
                        debugWarn("‚ö†Ô∏è ytPlayer.setVolume not available! Retrying in 1 second...");
                        setTimeout(() => {
                            if (ytPlayer && typeof ytPlayer.setVolume === 'function') {
                                ytPlayer.setVolume(volumePercent);
                                debugLog("‚úÖ Volume set (retry):", volumePercent + "%");
                            }
                        }, 1000);
                        return;
                    }

                    // ‚úÖ KEY FIX: Only unmute and play when volume > 0 (player is near store)
                    if (volumePercent > 0) {
                        // Player is near a store - unmute and ensure playing
                        ytPlayer.unMute();
                        ytPlayer.setVolume(volumePercent);

                        // Check if video is paused and needs to start playing
                        const playerState = ytPlayer.getPlayerState();
                        // States: -1 (unstarted), 0 (ended), 1 (playing), 2 (paused), 3 (buffering), 5 (video cued)
                        if (playerState === 2 || playerState === -1 || playerState === 5) {
                            ytPlayer.playVideo();
                            debugLog("‚ñ∂Ô∏è Started playing - player near store");
                        }
                        debugLog("‚úÖ Volume set:", volumePercent + "% (unmuted, playing)");
                    } else {
                        // Player is far from stores - mute and pause to save resources
                        ytPlayer.setVolume(0);
                        ytPlayer.mute();
                        // Don't pause - keep it running for sync, just muted
                        debugLog("üîá Volume set to 0% (muted - far from stores)");
                    }

                } catch (error) {
                    debugError("‚ùå Error setting volume:", error);
                    debugLog("Will retry in 1 second...");
                    setTimeout(() => {
                        try {
                            ytPlayer.setVolume(volumePercent);
                            debugLog("‚úÖ Volume set (error retry):", volumePercent + "%");
                        } catch (e) {
                            debugError("‚ùå Retry failed:", e);
                        }
                    }, 1000);
                }
            } else if (data.action === "forceVolumeUpdate") {
                // Force volume recalculation and update (used on resource restart)
                debugLog("üîÑ Force volume update requested - current stored volume:", currentMusicVolume + "%");
                if (ytPlayer && currentMusicVolume >= 0) {
                    // Use same logic as updateMusicVolume
                    if (currentMusicVolume > 0) {
                        ytPlayer.unMute();
                        ytPlayer.setVolume(currentMusicVolume);
                        const playerState = ytPlayer.getPlayerState();
                        if (playerState === 2 || playerState === -1 || playerState === 5) {
                            ytPlayer.playVideo();
                            debugLog("‚ñ∂Ô∏è Started playing on force update");
                        }
                        debugLog("‚úÖ Volume forced to:", currentMusicVolume + "% (unmuted)");
                    } else {
                        ytPlayer.setVolume(0);
                        ytPlayer.mute();
                        debugLog("üîá Volume forced to 0% (muted)");
                    }
                } else {
                    debugWarn("‚ö†Ô∏è Cannot force volume update - player not ready or no volume stored");
                }
            } else if (data.action === "showContainer") {
                document.getElementById("menuBox").style.display = "none";
                document.getElementById("container").style.display = "block";
                document.getElementById("firstPage").style.display = "none";
                document.getElementById("mainMenu").style.display = "none";
                document.getElementById("subMenu").style.display = "none";
                loadLanguageStrings(); // Load language strings when menu opens

                // ‚úÖ Store custom prices for this store
                if (data.customPrices && data.customPrices.length > 0) {
                    window.storeCustomPrices = data.customPrices;
                    debugLog("üìã Loaded", data.customPrices.length, "custom prices for store");
                } else {
                    window.storeCustomPrices = [];
                }

                // Add sound effects to all buttons
                addSoundEffectsToButtons();
            } else if (data.action === "showFirstPage") {
                document.getElementById("menuBox").style.display = "block";
                document.getElementById("container").style.display = "none";
                document.getElementById("firstPage").style.display = "block";
                document.getElementById("mainMenu").style.display = "none";
                document.getElementById("subMenu").style.display = "none";
                loadLanguageStrings(); // Load language strings when menu opens

                // Add sound effects to all buttons
                addSoundEffectsToButtons();
            } else if (data.action === "showMainMenu") {
                SkateStyle = data.skateStyle || "modern";

                // Clean up SkateType menu if still present
                const skateTypeElement = document.getElementById("skateTypeSelect");
                if (skateTypeElement) {
                    skateTypeElement.remove();
                }

                document.getElementById("firstPage").style.display = "none";
                document.getElementById("mainMenu").style.display = "block";
            } else if (data.action === "hideMenu") {
                document.getElementById("menuBox").style.display = "none";
                // Music continues playing in background (proximity-based volume)
            } else if (data.action === "closeDiscover") {
                // Close discover page from Lua
                document.getElementById("discoverPage").style.display = "none";
            } else if (data.action === "updateDiscoverVipStatus") {
                // Update VIP button state in discover page
                const btn = document.getElementById("discoverVipPurchase");
                if (btn && data.owned) {
                    btn.classList.add("owned");
                    btn.querySelector(".btn-text").textContent = "‚úì VIP ACTIVE";
                    btn.disabled = true;
                }
            } else if (data.action === "openUrl") {
                // Open external URL (Tebex, etc.)
                if (data.url) {
                    window.invokeNative("openUrl", data.url);
                }
            } else if (data.action === "showSkateTypeSelect") {
                // Remove any previous SkateType menu
                const existing = document.getElementById("skateTypeSelect");
                if (existing) existing.remove();

                document.getElementById("firstPage").style.display = "none";
                document.getElementById("mainMenu").style.display = "none";
                document.getElementById("subMenu").style.display = "none";

                const skateTypeSelectDiv = document.createElement("div");
                skateTypeSelectDiv.id = "skateTypeSelect";

                const buttonsDiv = document.createElement("div");
                buttonsDiv.className = "buttons";

                const modernBtn = document.createElement("button");
                modernBtn.className = "words-style";
                modernBtn.innerText = "Modern";
                modernBtn.onclick = () => sendSkateType("modern");

                const classicBtn = document.createElement("button");
                classicBtn.className = "words-style";
                classicBtn.innerText = "Classic";
                classicBtn.onclick = () => sendSkateType("classic");

                const backBtn = document.createElement("button");
                backBtn.className = "back-arrow";
                backBtn.innerHTML = "&#11013;";
                backBtn.onclick = () => {
                    skateTypeSelectDiv.remove();
                    goBack();
                };

                buttonsDiv.appendChild(modernBtn);
                buttonsDiv.appendChild(classicBtn);
                buttonsDiv.appendChild(backBtn);

                skateTypeSelectDiv.appendChild(buttonsDiv);
                document.getElementById("menuBox").appendChild(skateTypeSelectDiv);
            } else if (data.action === "receiveAllPurchases") {
                // üö´ BLOCK corrupted purchase data from individual resources
                if (data.itemType.endsWith('-style') || data.gender === 'last') {
                    debugWarn(`üö´ BLOCKED corrupted purchase data: ${data.itemType}/${data.gender}`);
                    return;
                }

                // Receive owned designs from server
                const key = `${data.itemType}_${data.gender}`;
                const newPurchases = data.purchases || [];

                // üîÑ MERGE instead of replace - keep all unique texture_ids
                if (!ownedDesigns[key]) {
                    ownedDesigns[key] = [];
                }

                // Create a map of existing purchases
                const existingMap = new Map();
                ownedDesigns[key].forEach(p => {
                    existingMap.set(p.texture_id, p);
                });

                // Add or update purchases from server
                newPurchases.forEach(p => {
                    existingMap.set(p.texture_id, p);
                });

                // Convert back to array
                ownedDesigns[key] = Array.from(existingMap.values());

                debugLog(`üíé Received ${newPurchases.length} owned designs for ${key}, total unique: ${ownedDesigns[key].length}`, ownedDesigns[key]);

                // Store equipped design (handle both boolean and number)
                const equipped = ownedDesigns[key].find(p => p.is_equipped === 1 || p.is_equipped === true);
                if (equipped) {
                    equippedDesigns[key] = equipped.texture_id;
                    debugLog(`‚úÖ Equipped design for ${key}: ${equipped.texture_id}`);
                } else {
                    // Clear equipped if none found
                    delete equippedDesigns[key];
                }

                // ‚úÖ Mark as loaded and resolve promise
                purchaseDataLoaded[key] = true;
                if (window.purchasePromiseHandlers && window.purchasePromiseHandlers[key]) {
                    clearTimeout(window.purchasePromiseHandlers[key].timeout);
                    window.purchasePromiseHandlers[key].resolve();
                    delete window.purchasePromiseHandlers[key];
                    debugLog(`‚úÖ Purchase promise resolved for ${key}`);
                }

                // ‚úÖ ALWAYS re-render if we're viewing this category (even if page isn't subMenu yet)
                // ‚úÖ For skateboard parts (deck/trucks/wheels), also check if currentCategory is "skateboard"
                const skateboardParts = ["deck", "trucks", "wheels"];
                const isSkateboardPart = skateboardParts.includes(data.itemType);
                const shouldRerender = (currentCategory === data.itemType && currentStyle === data.gender) ||
                                       (currentCategory === "skateboard" && isSkateboardPart && currentStyle === data.gender);

                if (shouldRerender) {
                    debugLog(`üîÑ Purchase data received for ${data.itemType}/${data.gender} - re-rendering designs...`);

                    // Small delay to ensure DOM is ready
                    setTimeout(() => {
                        // Check if we have design options to re-render
                        const optionsContainer = document.getElementById("options");
                        if (optionsContainer && optionsContainer.children.length > 0) {
                            debugLog("üîÑ Re-rendering existing designs with ownership status...");

                            // ‚úÖ For skateboard parts, pass the part type to get the correct design data
                            const partType = isSkateboardPart ? data.itemType : null;
                            const submenuTitle = document.getElementById("submenu-title");
                            let currentPart = submenuTitle ? submenuTitle.innerText.toLowerCase() : null;

                            // ‚úÖ Only use currentPart if it's an actual part name, not "select design"
                            if (currentPart === "select design") {
                                currentPart = null;
                            }

                            // Re-fetch design data and re-render
                            fetch(`https://${GetParentResourceName()}/getDesignCount`, {
                                method: "POST",
                                body: JSON.stringify({ part: partType || currentPart, category: currentCategory, style: currentStyle })
                            })
                                .then(response => response.json())
                                .then(designData => {
                                    renderDesignOptions(designData.count, designData.prefix, designData.resourceName, partType || currentPart, designData.imagePath, designData.price);
                                })
                                .catch(error => debugError("Failed to get design count for re-render:", error));
                        } else {
                            debugLog("‚è≥ Designs not rendered yet - ownership will show when rendered");
                        }
                    }, 50);
                }
            } else if (data.action === "equipResult") {
                // Result of equip request
                if (data.success) {
                    debugLog(`‚úÖ Successfully equipped design ${data.textureId}`);

                    // Update equipped status locally
                    const key = `${currentCategory}_${currentStyle}`;
                    equippedDesigns[key] = data.textureId;

                    // Re-render to update button states
                    const currentPart = document.getElementById("submenu-title").innerText.toLowerCase();
                    showSubMenu(currentPart === "select design" ? null : currentPart);
                } else {
                    debugError("‚ùå Failed to equip design");
                }
            } else if (data.transactionType === "stopSound") {
                if (data.player === 1) {
                    audioPlayer1.pause();
                    audioPlayer1.currentTime = 0;
                } else if (data.player === 2) {
                    audioPlayer2.pause();
                    audioPlayer2.currentTime = 0;
                } else if (data.player === 3) {
                    audioPlayer3.pause();
                    audioPlayer3.currentTime = 0;
                }
            }
        });

        // Audio Player Integration
        const audioPlayer1 = document.getElementById("audioPlayer1");
        const audioPlayer2 = document.getElementById("audioPlayer2");
        const audioPlayer3 = document.getElementById("audioPlayer3");

        audioPlayer1.volume = 1;
        audioPlayer2.volume = 1;
        audioPlayer3.volume = 1.0; // Set to max, we'll use Web Audio API for amplification

        // Web Audio API for amplified player 3 (reaction sounds)
        let audioContext = null;
        let gainNode = null;
        let sourceNode = null;

        function initWebAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);

                // Connect audio element to Web Audio API
                sourceNode = audioContext.createMediaElementSource(audioPlayer3);
                sourceNode.connect(gainNode);
            }
        }

        window.addEventListener("message", (event) => {
            const data = event.data;

            // Play sound on specific player based on the message
            if (data.transactionType === "playSound") {
                if (data.player === 1) {
                    if (data.volume !== undefined) audioPlayer1.volume = data.volume;
                    audioPlayer1.src = data.transactionFile;
                    // Silently catch autoplay errors (browser policy - requires user interaction)
                    audioPlayer1.play().catch(() => {});
                } else if (data.player === 2) {
                    if (data.volume !== undefined) audioPlayer2.volume = data.volume;
                    audioPlayer2.src = data.transactionFile;
                    // Silently catch autoplay errors (browser policy - requires user interaction)
                    audioPlayer2.play().catch(() => {});
                } else if (data.player === 3) {
                    debugLog(`üé§ Attempting to play audio on player 3: ${data.transactionFile} at amplified volume ${data.volume}`);

                    // Initialize Web Audio API on first use
                    initWebAudio();

                    // Set gain (amplification) - can go beyond 1.0!
                    if (data.volume !== undefined && gainNode) {
                        gainNode.gain.value = data.volume;
                        debugLog(`   Gain (amplification) set to: ${gainNode.gain.value}`);
                    }

                    audioPlayer3.src = data.transactionFile;
                    debugLog(`   Source set to: ${audioPlayer3.src}`);
                    // Silently catch autoplay errors (browser policy - requires user interaction)
                    audioPlayer3.play()
                        .then(() => debugLog(`   ‚úÖ Audio playing successfully with amplification`))
                        .catch(() => {});
                }
            }

            // Stop sound on the specific player
            else if (data.transactionType === "stopSound") {
                if (data.player === 1) {
                    audioPlayer1.pause();
                    audioPlayer1.currentTime = 0;
                } else if (data.player === 2) {
                    audioPlayer2.pause();
                    audioPlayer2.currentTime = 0;
                } else if (data.player === 3) {
                    audioPlayer3.pause();
                    audioPlayer3.currentTime = 0;
                }
            }

            // Set volume for the specific player
            else if (data.transactionType === "setVolume") {
                if (data.player === 1) {
                    audioPlayer1.volume = data.volume;
                } else if (data.player === 2) {
                    audioPlayer2.volume = data.volume;
                } else if (data.player === 3) {
                    audioPlayer3.volume = data.volume;
                }
            }

            // üöÄ Boost Bar - Toggle visibility
            else if (data.type === "toggle_boost_bar") {
                const boostContainer = document.getElementById("boostBarContainer");
                if (data.state) {
                    boostContainer.style.display = "block";
                } else {
                    boostContainer.style.display = "none";
                }
            }

            // üöÄ Boost Bar - Update value
            else if (data.type === "boost_bar") {
                const boostFill = document.getElementById("boostBarFill");
                const boostPercentage = document.getElementById("boostPercentage");
                const value = Math.max(0, Math.min(100, data.value)); // Clamp between 0-100

                // Update bar width
                boostFill.style.width = value + "%";

                // Update percentage text
                boostPercentage.textContent = Math.round(value) + "%";

                // Add warning effect when low
                if (value < 25) {
                    boostFill.classList.add("low-boost");
                } else {
                    boostFill.classList.remove("low-boost");
                }
            }
        });

        // ‚úÖ Removed duplicate/incorrect closeContainer event listener
        // The correct close button is "closeContainerNew" which is already handled above

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üè™ MANAGEMENT MENU HANDLERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let currentStoreData = null;

        // Receive management menu data
        window.addEventListener('message', function(event) {
            const data = event.data;

            if (data.action === 'showManagementMenu') {
                currentStoreData = data.storeData;

                // Check if menu is already open
                const isOpen = document.getElementById('management-container').style.display === 'flex';

                if (isOpen) {
                    // Menu is already open - just update the data, don't switch tabs
                    console.log('[Management Menu] Updating existing menu with new data');
                    populateStoreData(data.storeData);
                } else {
                    // Menu is closed - open it and switch to pricing tab
                    openManagementMenu(data.storeData);
                }
            } else if (data.action === 'closeManagementMenu') {
                closeManagementMenu();
            }
        });

        function openManagementMenu(storeData) {
            console.log('[Management Menu] Opening with data:', storeData);
            console.log('[Management Menu] forSale:', storeData.forSale, 'salePrice:', storeData.salePrice);

            document.getElementById('management-container').style.display = 'flex';
            document.getElementById('store-title').textContent = storeData.storeName + ' Management';

            populateStoreData(storeData);
            switchTab('pricing');
        }

        function closeManagementMenu() {
            document.getElementById('management-container').style.display = 'none';
            fetch(`https://${GetParentResourceName()}/closeManagement`, {
                method: 'POST',
                body: JSON.stringify({})
            });
        }

        function populateStoreData(storeData) {
            if (storeData.customPrices) {
                storeData.customPrices.forEach(priceData => {
                    const fieldId = buildPriceFieldId(priceData.category, priceData.item_type, priceData.style);
                    const field = document.getElementById(fieldId);
                    if (field) field.value = priceData.price;
                });
            }

            // Populate equipment prices
            if (storeData.equipmentPrices) {
                const helmetField = document.getElementById('price-equipment-helmet');
                const forearmsField = document.getElementById('price-equipment-forearms');
                const shinguardsField = document.getElementById('price-equipment-shinguards');

                // Only populate if different from default values
                if (helmetField && storeData.equipmentPrices.helmet && storeData.equipmentPrices.helmet !== 5000) {
                    helmetField.value = storeData.equipmentPrices.helmet;
                }
                if (forearmsField && storeData.equipmentPrices.forearms && storeData.equipmentPrices.forearms !== 3500) {
                    forearmsField.value = storeData.equipmentPrices.forearms;
                }
                if (shinguardsField && storeData.equipmentPrices.shinguards && storeData.equipmentPrices.shinguards !== 3500) {
                    shinguardsField.value = storeData.equipmentPrices.shinguards;
                }
            }

            if (storeData.customHours) {
                document.getElementById('open-hour').value = storeData.customHours.open_hour;
                document.getElementById('close-hour').value = storeData.customHours.close_hour;

                if (storeData.customHours.open_hour === 0 && storeData.customHours.close_hour === 24) {
                    document.getElementById('always-open').checked = true;
                    disableHourInputs(true);
                }
            }

            document.getElementById('original-price').textContent = '$' + formatNumber(storeData.purchasePrice);

            // ‚úÖ Show/hide sections based on whether store is listed for sale
            console.log('[populateStoreData] Checking forSale:', storeData.forSale, typeof storeData.forSale);

            if (storeData.forSale) {
                console.log('[populateStoreData] Store IS listed for sale - showing cancel button');
                document.getElementById('sale-status').textContent = 'Listed for $' + formatNumber(storeData.salePrice);
                document.getElementById('sale-price').value = storeData.salePrice;

                // Hide the list for sale and sellback sections when already listed
                document.getElementById('list-for-sale-section').style.display = 'none';
                document.getElementById('sellback-section').style.display = 'none';

                // Show the cancel sale button
                document.getElementById('cancel-sale-section').style.display = 'block';
            } else {
                console.log('[populateStoreData] Store NOT listed for sale - showing list/sellback buttons');
                document.getElementById('sale-status').textContent = 'Not Listed';

                // Show the list for sale and sellback sections when not listed
                document.getElementById('list-for-sale-section').style.display = 'block';
                document.getElementById('sellback-section').style.display = 'block';

                // Hide the cancel sale button
                document.getElementById('cancel-sale-section').style.display = 'none';
            }

            const sellbackAmount = Math.floor(storeData.purchasePrice * 0.7);
            document.getElementById('sellback-amount').textContent = '$' + formatNumber(sellbackAmount);
        }

        function buildPriceFieldId(category, itemType, style) {
            let id = 'price-' + category;
            if (itemType) id += '-' + itemType;
            if (style) id += '-' + style;
            return id;
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-btn[data-tab="' + tabName + '"]').classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                switchTab(this.getAttribute('data-tab'));
            });
        });

        document.getElementById('close-management').addEventListener('click', closeManagementMenu);

        document.getElementById('save-pricing').addEventListener('click', function() {
            const customPrices = [];

            // Skateboard - Has both parts AND styles (modern/classic for each part)
            const skateboardParts = [
                { category: 'skateboard', itemType: 'deck', style: 'modern' },
                { category: 'skateboard', itemType: 'deck', style: 'classic' },
                { category: 'skateboard', itemType: 'trucks', style: 'modern' },
                { category: 'skateboard', itemType: 'trucks', style: 'classic' },
                { category: 'skateboard', itemType: 'wheels', style: 'modern' },
                { category: 'skateboard', itemType: 'wheels', style: 'classic' }
            ];

            skateboardParts.forEach(part => {
                const fieldId = buildPriceFieldId(part.category, part.itemType, part.style);
                const value = document.getElementById(fieldId).value;
                if (value && value > 0) {
                    customPrices.push({
                        category: part.category,
                        itemType: part.itemType,
                        style: part.style,
                        price: parseInt(value)
                    });
                }
            });

            // BMX - Simple (no styles, no parts)
            const bmxValue = document.getElementById('price-bmx').value;
            if (bmxValue && bmxValue > 0) {
                customPrices.push({
                    category: 'bmx',
                    itemType: null,
                    style: null,
                    price: parseInt(bmxValue)
                });
            }

            // Hoverboard - Has styles (ultra/retro)
            ['ultra', 'retro'].forEach(style => {
                const value = document.getElementById('price-hoverboard-' + style).value;
                if (value && value > 0) {
                    customPrices.push({
                        category: 'hoverboard',
                        itemType: null,
                        style: style,
                        price: parseInt(value)
                    });
                }
            });

            // Rollers - Has styles (modern/retro)
            ['modern', 'retro'].forEach(style => {
                const value = document.getElementById('price-rollers-' + style).value;
                if (value && value > 0) {
                    customPrices.push({
                        category: 'rollers',
                        itemType: null,
                        style: style,
                        price: parseInt(value)
                    });
                }
            });

            // Scooter - Simple (no styles, no parts)
            const scooterValue = document.getElementById('price-scooter').value;
            if (scooterValue && scooterValue > 0) {
                customPrices.push({
                    category: 'scooter',
                    itemType: null,
                    style: null,
                    price: parseInt(scooterValue)
                });
            }

            // Ski - Simple (no styles, no parts)
            const skiValue = document.getElementById('price-ski').value;
            if (skiValue && skiValue > 0) {
                customPrices.push({
                    category: 'ski',
                    itemType: null,
                    style: null,
                    price: parseInt(skiValue)
                });
            }

            // Ice Skates - Simple (no styles, no parts)
            const iceskatesValue = document.getElementById('price-iceskates').value;
            if (iceskatesValue && iceskatesValue > 0) {
                customPrices.push({
                    category: 'iceskates',
                    itemType: null,
                    style: null,
                    price: parseInt(iceskatesValue)
                });
            }

            // Snowboard - Simple (no styles, no parts)
            const snowboardValue = document.getElementById('price-snowboard').value;
            if (snowboardValue && snowboardValue > 0) {
                customPrices.push({
                    category: 'snowboard',
                    itemType: null,
                    style: null,
                    price: parseInt(snowboardValue)
                });
            }

            // Equipment: Protection Gear
            const equipmentHelmetValue = document.getElementById('price-equipment-helmet').value;
            if (equipmentHelmetValue && equipmentHelmetValue > 0) {
                customPrices.push({
                    category: 'equipment-helmet',
                    itemType: null,
                    style: null,
                    price: parseInt(equipmentHelmetValue)
                });
            }

            const equipmentForearmsValue = document.getElementById('price-equipment-forearms').value;
            if (equipmentForearmsValue && equipmentForearmsValue > 0) {
                customPrices.push({
                    category: 'equipment-forearms',
                    itemType: null,
                    style: null,
                    price: parseInt(equipmentForearmsValue)
                });
            }

            const equipmentShinguardsValue = document.getElementById('price-equipment-shinguards').value;
            if (equipmentShinguardsValue && equipmentShinguardsValue > 0) {
                customPrices.push({
                    category: 'equipment-shinguards',
                    itemType: null,
                    style: null,
                    price: parseInt(equipmentShinguardsValue)
                });
            }

            fetch(`https://${GetParentResourceName()}/saveCustomPricing`, {
                method: 'POST',
                body: JSON.stringify({
                    storeName: currentStoreData.storeName,
                    prices: customPrices
                })
            });
        });

        document.getElementById('reset-pricing').addEventListener('click', function() {
            document.querySelectorAll('input[id^="price-"]').forEach(input => input.value = '');

            fetch(`https://${GetParentResourceName()}/resetCustomPricing`, {
                method: 'POST',
                body: JSON.stringify({
                    storeName: currentStoreData.storeName
                })
            });
        });

        document.getElementById('always-open').addEventListener('change', function() {
            const isChecked = this.checked;
            disableHourInputs(isChecked);

            if (isChecked) {
                document.getElementById('open-hour').value = 0;
                document.getElementById('close-hour').value = 24;
            }
        });

        function disableHourInputs(disabled) {
            document.getElementById('open-hour').disabled = disabled;
            document.getElementById('close-hour').disabled = disabled;
        }

        document.getElementById('save-hours').addEventListener('click', function() {
            const openHour = parseInt(document.getElementById('open-hour').value);
            const closeHour = parseInt(document.getElementById('close-hour').value);

            if (openHour === closeHour) {
                alert('Opening and closing hours cannot be the same!');
                return;
            }

            fetch(`https://${GetParentResourceName()}/saveCustomHours`, {
                method: 'POST',
                body: JSON.stringify({
                    storeName: currentStoreData.storeName,
                    openHour: openHour,
                    closeHour: closeHour
                })
            });
        });

        document.getElementById('list-for-sale').addEventListener('click', function() {
            const salePrice = parseInt(document.getElementById('sale-price').value);

            if (!salePrice || salePrice <= 0) {
                alert('Please enter a valid sale price!');
                return;
            }

            fetch(`https://${GetParentResourceName()}/listStoreForSale`, {
                method: 'POST',
                body: JSON.stringify({
                    storeName: currentStoreData.storeName,
                    salePrice: salePrice
                })
            });

            // DON'T close menu - let user reopen it to see the updated status
            // closeManagementMenu();
        });

        document.getElementById('sellback-store').addEventListener('click', function() {
            const sellbackAmount = Math.floor(currentStoreData.purchasePrice * 0.7);

            fetch(`https://${GetParentResourceName()}/sellbackStore`, {
                method: 'POST',
                body: JSON.stringify({
                    storeName: currentStoreData.storeName,
                    sellbackAmount: sellbackAmount
                })
            });

            closeManagementMenu();
        });

        document.getElementById('cancel-sale').addEventListener('click', function() {
            fetch(`https://${GetParentResourceName()}/cancelSaleListing`, {
                method: 'POST',
                body: JSON.stringify({
                    storeName: currentStoreData.storeName
                })
            });

            // DON'T close menu - let user reopen it to see the updated status
            // closeManagementMenu();
        });

        document.addEventListener('keyup', function(e) {
            if (e.key === 'Escape' && document.getElementById('management-container').style.display !== 'none') {
                closeManagementMenu();
            }
        });

    </script>
    <!--<script src="Main.js"></script>-->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- üé° GEAR WHEEL MENU -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="gear-wheel-container" style="display: none;">
        <div id="gear-wheel">
            <div class="wheel-center"></div>
            <div id="gear-segments"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- üõ°Ô∏è EQUIPMENT SYSTEM - Sidebar Style -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="equipmentContainer" style="display: none;">
        <!-- Background Decoration -->
        <div class="equipment-background-decoration"></div>

        <!-- Close Button (Top Right) -->
        <button class="equipment-close-btn" onclick="equipmentClose()">‚úï</button>

        <!-- Back Button (Top Left) -->
        <button class="equipment-back-btn" onclick="equipmentGoBack()">‚Üê</button>

        <!-- Header -->
        <div class="equipment-header">
            <h1 class="equipment-title">Equipment</h1>
            <p class="equipment-subtitle">Protection Gear</p>
        </div>

        <!-- Sport Selection Page -->
        <div id="equipmentSportSelection" class="equipment-page active">
            <div id="equipmentSportGrid"></div>
        </div>

        <!-- Category Selection Page -->
        <div id="equipmentCategorySelection" class="equipment-page">
            <div id="equipmentCategoryGrid"></div>
        </div>

        <!-- Model Selection Page -->
        <div id="equipmentModelSelection" class="equipment-page">
            <div id="equipmentModelGrid"></div>
            <div class="equipment-action-buttons"></div>
        </div>
    </div>

    <!-- Gear Wheel Sound Effects -->
    <audio id="gearWheelSelectSound" src="sounds/select.MP3" preload="auto"></audio>
    <audio id="gearWheelCameraFlashSound" src="sounds/camera-flash.MP3" preload="auto"></audio>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- üéÅ EXCLUSIVE PACKAGE POPUP (Comic Bubble - Emerges from Menu) -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="exclusivePackagePopup" class="comic-bubble-container" style="display: none;">
        <div class="comic-bubble">
            <!-- Bubble Tail (Points to Menu) -->
            <div class="comic-bubble-tail"></div>

            <!-- Inner wrapper for content clipping -->
            <div class="comic-bubble-inner">
                <!-- Close Button -->
                <button class="comic-close-btn" onclick="closeExclusivePopup()">‚úï</button>

                <!-- Header with Badge -->
                <div class="comic-header">
                    <!-- Star-shaped pack image (background layer) -->
                    <img id="popupPackageImage" src="images/discover/pack-1.jpg" alt="Package" class="comic-pack-bg-image">
                    <!-- Logo and Badge row -->
                    <div class="comic-badge-row">
                        <img src="images/Logos/logo.png" alt="Logo" class="comic-header-logo">
                        <div class="comic-badge">‚ú® NEO XTREME</div>
                    </div>
                </div>

            <!-- Content -->
            <div class="comic-content">
                <h2 id="popupPackageName" class="comic-title">Neo Xtreme Pack</h2>
                <p id="popupPackageDescription" class="comic-description">Unlock exclusive helmets, forearms and shinguards</p>

                <!-- Purchase Button -->
                <button class="comic-btn comic-btn-purchase" onclick="openPackageUrl()">
                    <span>üõí</span> Purchase Now
                </button>

                <!-- Divider -->
                <div class="comic-divider">
                    <span>Already own it?</span>
                </div>

                <!-- Discord Redeem Section -->
                <div class="comic-redeem">
                    <!-- Step 1: Enter Discord ID -->
                    <div id="verifyStep1" class="verify-step">
                        <div class="comic-input-row" style="flex-direction: column; gap: 10px;">
                            <input type="text" id="discordIdInput" class="comic-input" placeholder="Your Discord ID" maxlength="19" style="width: 100%;">
                            <button id="redeemBtn" class="comic-btn comic-btn-redeem" onclick="requestVerificationCode()" style="width: 100%;">
                                GET VERIFICATION CODE
                            </button>
                        </div>

                        <!-- Help Toggle -->
                        <button class="comic-help-toggle" onclick="toggleDiscordHelp()">
                            ‚ùì How to get your Discord ID
                        </button>

                        <!-- Help Section -->
                        <div id="discordHelpSection" class="comic-help" style="display: none;">
                            <div class="comic-help-step"><span>1</span> Open Discord ‚Üí User Settings ‚öôÔ∏è</div>
                            <div class="comic-help-step"><span>2</span> Advanced ‚Üí Enable Developer Mode</div>
                            <div class="comic-help-step"><span>3</span> Right-click your name ‚Üí Copy User ID</div>
                            <div class="comic-help-note">üí° Must be in our Discord server!</div>
                        </div>
                    </div>

                    <!-- Step 2: Show Verification Code -->
                    <div id="verifyStep2" class="verify-step" style="display: none;">
                        <div class="verification-code-display">
                            <div class="code-instruction">Type this code in our Discord:</div>
                            <div id="verificationCodeBox" class="verification-code-box">VERIFY-XXXXXX</div>
                            <button class="comic-btn-copy" onclick="copyVerificationCode()">
                                <span>üìã</span> Copy Code
                            </button>
                        </div>
                        <div class="verification-channel-info">
                            <div class="channel-label">Go to channel:</div>
                            <div class="channel-name">üó£Ô∏±verify-add-on</div>
                        </div>
                        <div class="verification-waiting">
                            <div class="waiting-spinner"></div>
                            <span>Waiting for verification...</span>
                        </div>
                        <button class="comic-btn-back" onclick="goBackToStep1()">
                            ‚Üê Enter different Discord ID
                        </button>
                    </div>

                    <!-- Status Message (shared between steps) -->
                    <div id="redeemStatus" class="comic-status" style="display: none;"></div>
                </div>

                <!-- Discord Invite Section (Collapsible) -->
                <div class="discord-invite-section">
                    <button id="discordInviteToggle" class="discord-invite-toggle" onclick="toggleDiscordInvite()">
                        <span id="discordInviteText">Want to find our Discord?</span>
                        <span id="discordInviteArrow" class="toggle-arrow">‚ñº</span>
                    </button>
                    <div id="discordInviteContent" class="discord-invite-content" style="display: none;">
                        <button id="discordJoinBtn" class="comic-btn comic-btn-discord" onclick="openDiscordInvite()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
                            </svg>
                            <span id="discordJoinText">Join Discord</span>
                        </button>
                    </div>
                </div>
            </div>
            </div> <!-- Close comic-bubble-inner -->
        </div>
    </div>

    <style>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /* üéÅ COMIC SPEECH BUBBLE - Menu is Speaking! */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        .comic-bubble-container {
            position: fixed;
            top: 50%;
            /* Position next to the equipment menu (menu is at left: 10%, width: 380px) */
            left: calc(10% + 380px + 60px);
            transform: translateY(-50%);
            z-index: 9999;
            pointer-events: none;
        }

        .comic-bubble {
            position: relative;
            width: 380px;
            background: linear-gradient(145deg, #fffef5 0%, #fff9e6 100%);
            border: 4px solid #1a1a1a;
            border-radius: 30px 30px 30px 8px;
            box-shadow:
                8px 8px 0 0 #1a1a1a,
                0 15px 40px rgba(0, 0, 0, 0.4);
            animation: speechBubblePop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: all;
            overflow: visible;
        }

        @keyframes speechBubblePop {
            0% {
                opacity: 0;
                transform: scale(0.2) translateX(-100px);
            }
            50% {
                transform: scale(1.08) translateX(10px);
            }
            70% {
                transform: scale(0.95) translateX(-5px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateX(0);
            }
        }

        /* Comic Speech Tail - Curved pointer toward the menu */
        .comic-bubble-tail {
            position: absolute;
            left: -50px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 40px;
            overflow: visible;
            z-index: -1;
        }

        /* Main curved tail shape */
        .comic-bubble-tail::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 55px;
            height: 30px;
            background: linear-gradient(145deg, #fffef5 0%, #fff9e6 100%);
            border: 4px solid #1a1a1a;
            border-right: none;
            border-radius: 0 0 0 25px;
            clip-path: polygon(100% 0%, 100% 100%, 30% 100%, 0% 50%, 30% 0%);
        }

        /* Tail shadow */
        .comic-bubble-tail::after {
            content: '';
            position: absolute;
            left: 8px;
            top: calc(50% + 8px);
            transform: translateY(-50%);
            width: 45px;
            height: 25px;
            background: #1a1a1a;
            border-radius: 0 0 0 20px;
            clip-path: polygon(100% 0%, 100% 100%, 30% 100%, 0% 50%, 30% 0%);
            z-index: -2;
        }

        /* Speech dots (small bubbles leading from menu) */
        .comic-bubble::before {
            content: '';
            position: absolute;
            left: -75px;
            top: 45%;
            width: 18px;
            height: 18px;
            background: linear-gradient(145deg, #fffef5 0%, #fff9e6 100%);
            border: 3px solid #1a1a1a;
            border-radius: 50%;
            box-shadow: 3px 3px 0 0 #1a1a1a;
            animation: dotBounce 0.5s ease-out 0.2s both;
        }

        .comic-bubble::after {
            content: '';
            position: absolute;
            left: -100px;
            top: 42%;
            width: 12px;
            height: 12px;
            background: linear-gradient(145deg, #fffef5 0%, #fff9e6 100%);
            border: 3px solid #1a1a1a;
            border-radius: 50%;
            box-shadow: 2px 2px 0 0 #1a1a1a;
            animation: dotBounce 0.5s ease-out 0.35s both;
        }

        @keyframes dotBounce {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            60% {
                transform: scale(1.3);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Inner content wrapper to prevent overflow issues */
        .comic-bubble-inner {
            overflow: hidden;
            border-radius: 26px 26px 26px 4px;
        }

        /* Close Button - Comic style */
        .comic-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: 3px solid #1a1a1a;
            background: #fff;
            color: #1a1a1a;
            font-size: 18px;
            font-weight: 900;
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s ease;
            box-shadow: 3px 3px 0 0 #1a1a1a;
            /* Center the X */
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: 0;
        }

        .comic-close-btn:hover {
            background: #ff4757;
            color: #fff;
            border-color: #1a1a1a;
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 0 #1a1a1a;
        }

        /* Header - Comic book style */
        .comic-header {
            position: relative;
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid #1a1a1a;
            min-height: 120px;
            overflow: hidden;
        }

        /* Pack image - background layer with bounce animation */
        .comic-pack-bg-image {
            position: absolute;
            top: 55%;
            transform: translateY(-50%);
            width: 140px;
            height: auto;
            object-fit: contain;
            z-index: 1;
            opacity: 0.95;
            /* Black thick outline */
            border: 4px solid #1a1a1a;
            border-radius: 8px;
            box-shadow: 4px 4px 0 0 #1a1a1a;
            animation: packBounce 2.5s ease-in-out infinite;
        }

        @keyframes packBounce {
            0%, 100% { left: 10px; }
            50% { left: calc(100% - 158px); }
        }

        /* Badge row - logo and badge */
        .comic-badge-row {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Small logo on the left of badge */
        .comic-header-logo {
            width: 50px;
            height: auto;
            filter: drop-shadow(2px 2px 0 rgba(0, 0, 0, 0.3));
        }

        .comic-badge {
            display: inline-block;
            background: #ffd700;
            color: #1a1a1a;
            font-size: 11px;
            font-weight: 900;
            padding: 6px 14px;
            border-radius: 0;
            letter-spacing: 2px;
            border: 3px solid #1a1a1a;
            box-shadow: 4px 4px 0 0 #1a1a1a;
            text-transform: uppercase;
            animation: badgeWiggle 2s ease-in-out infinite;
        }

        @keyframes badgeWiggle {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        /* Content - Comic style with dark text */
        .comic-content {
            padding: 20px;
            background: linear-gradient(145deg, #fffef5 0%, #fff9e6 100%);
        }

        .comic-title {
            color: #1a1a1a;
            font-size: 20px;
            font-weight: 900;
            margin: 0 0 8px 0;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .comic-description {
            color: #444;
            font-size: 13px;
            text-align: center;
            margin: 0 0 15px 0;
            line-height: 1.5;
            font-weight: 500;
        }

        /* Buttons - Comic book style */
        .comic-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            border: 3px solid #1a1a1a;
            border-radius: 0;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 4px 4px 0 0 #1a1a1a;
        }

        .comic-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 0 #1a1a1a;
        }

        .comic-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 0 #1a1a1a;
        }

        .comic-btn-purchase {
            background: #38ef7d;
            color: #1a1a1a;
        }

        .comic-btn-purchase:hover {
            background: #4af78d;
        }

        /* Divider - Comic style */
        .comic-divider {
            display: flex;
            align-items: center;
            margin: 18px 0;
            color: #666;
            font-size: 11px;
            font-weight: 700;
        }

        .comic-divider::before,
        .comic-divider::after {
            content: '';
            flex: 1;
            height: 3px;
            background: #1a1a1a;
        }

        .comic-divider span {
            padding: 0 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Redeem Section */
        .comic-redeem {
            text-align: center;
        }

        .comic-input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .comic-input {
            flex: 1;
            padding: 10px 12px;
            border: 3px solid #1a1a1a;
            border-radius: 0;
            background: #fff;
            color: #1a1a1a;
            font-size: 13px;
            font-weight: 600;
            outline: none;
            transition: all 0.2s ease;
            box-shadow: 3px 3px 0 0 #1a1a1a;
        }

        .comic-input:focus {
            background: #f0f0ff;
            box-shadow: 4px 4px 0 0 #5865F2;
            border-color: #5865F2;
        }

        .comic-input::placeholder {
            color: #888;
            font-weight: 500;
        }

        .comic-btn-redeem {
            background: #5865F2;
            color: #fff;
            width: auto;
            min-width: 110px;
            padding: 10px 16px;
            white-space: nowrap;
            font-size: 13px;
        }

        .comic-btn-redeem:hover {
            background: #6b77f5;
        }

        .comic-btn-redeem:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 4px 4px 0 0 #1a1a1a;
        }

        /* Status Messages - Comic style */
        .comic-status {
            padding: 10px 12px;
            border-radius: 0;
            margin-bottom: 10px;
            font-size: 12px;
            font-weight: 700;
            border: 3px solid #1a1a1a;
            animation: comicStatusPop 0.3s ease;
        }

        @keyframes comicStatusPop {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .comic-status.success {
            background: #38ef7d;
            color: #1a1a1a;
            box-shadow: 3px 3px 0 0 #1a1a1a;
        }

        .comic-status.error {
            background: #ff6b6b;
            color: #1a1a1a;
            box-shadow: 3px 3px 0 0 #1a1a1a;
        }

        .comic-status.loading {
            background: #ffd700;
            color: #1a1a1a;
            box-shadow: 3px 3px 0 0 #1a1a1a;
        }

        /* Help Toggle - Comic style */
        .comic-help-toggle {
            background: transparent;
            border: none;
            color: #666;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px;
            width: 100%;
            transition: color 0.2s ease;
        }

        .comic-help-toggle:hover {
            color: #1a1a1a;
        }

        /* Help Section - Comic style */
        .comic-help {
            margin-top: 10px;
            padding: 12px;
            background: #fff;
            border: 3px solid #1a1a1a;
            text-align: left;
            animation: comicHelpSlide 0.3s ease;
            box-shadow: 3px 3px 0 0 #1a1a1a;
        }

        @keyframes comicHelpSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .comic-help-step {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1a1a1a;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .comic-help-step:last-of-type {
            margin-bottom: 0;
        }

        .comic-help-step span:first-child {
            min-width: 22px;
            height: 22px;
            background: #5865F2;
            color: #fff;
            border: 2px solid #1a1a1a;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 900;
        }

        .comic-help-note {
            margin-top: 10px;
            padding: 8px;
            background: #ffd700;
            border: 2px solid #1a1a1a;
            color: #1a1a1a;
            font-size: 10px;
            font-weight: 700;
            text-align: center;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /* üéÆ DISCORD INVITE SECTION STYLES - Comic style */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        .discord-invite-section {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 3px solid #1a1a1a;
        }

        .discord-invite-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .discord-invite-toggle:hover {
            color: #1a1a1a;
        }

        .discord-invite-toggle .toggle-arrow {
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        .discord-invite-toggle.active .toggle-arrow {
            transform: rotate(180deg);
        }

        .discord-invite-content {
            margin-top: 10px;
            animation: discordInviteSlide 0.3s ease;
        }

        @keyframes discordInviteSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .comic-btn-discord {
            background: #5865F2;
            color: #fff;
        }

        .comic-btn-discord:hover {
            background: #6b77f5;
        }

        .comic-btn-discord svg {
            flex-shrink: 0;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /* üîê VERIFICATION CODE DISPLAY STYLES - Comic style */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        .verify-step {
            transition: all 0.3s ease;
        }

        .verification-code-display {
            text-align: center;
            padding: 15px 0;
        }

        .code-instruction {
            color: #444;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .verification-code-box {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 22px;
            font-weight: 900;
            letter-spacing: 3px;
            color: #1a1a1a;
            background: #ffd700;
            border: 4px solid #1a1a1a;
            border-radius: 0;
            padding: 15px 20px;
            margin: 10px 0;
            user-select: all;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 4px 4px 0 0 #1a1a1a;
        }

        .verification-code-box:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 0 #1a1a1a;
        }

        .comic-btn-copy {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #fff;
            border: 3px solid #1a1a1a;
            border-radius: 0;
            color: #1a1a1a;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 3px 3px 0 0 #1a1a1a;
        }

        .comic-btn-copy:hover {
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 0 #1a1a1a;
        }

        .comic-btn-copy.copied {
            background: #38ef7d;
            color: #1a1a1a;
        }

        .verification-channel-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: #fff;
            border: 3px solid #1a1a1a;
            margin: 15px 0;
            box-shadow: 3px 3px 0 0 #1a1a1a;
        }

        .channel-label {
            color: #666;
            font-size: 11px;
            font-weight: 600;
        }

        .channel-name {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            background: #5865f2;
            padding: 4px 10px;
            border: 2px solid #1a1a1a;
        }

        .verification-waiting {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            color: #444;
            font-size: 12px;
            font-weight: 600;
        }

        .waiting-spinner {
            width: 18px;
            height: 18px;
            border: 3px solid #ddd;
            border-top-color: #ff69b4;
            border-radius: 50%;
            animation: waitingSpin 0.8s linear infinite;
        }

        @keyframes waitingSpin {
            to { transform: rotate(360deg); }
        }

        .comic-btn-back {
            display: block;
            width: 100%;
            padding: 10px;
            background: #fff;
            border: 2px solid #1a1a1a;
            color: #666;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-top: 10px;
            box-shadow: 2px 2px 0 0 #1a1a1a;
        }

        .comic-btn-back:hover {
            background: #f5f5f5;
            color: #1a1a1a;
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 0 #1a1a1a;
        }

        /* Success animation for verification */
        .verification-success {
            animation: successPulse 0.5s ease;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üéÅ EXCLUSIVE PACKAGE POPUP FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let currentPackageId = null;
        let currentPackageUrl = null;
        let currentVerificationCode = null;

        function showExclusivePopup(packageInfo) {
            console.log("showExclusivePopup called with:", packageInfo);
            currentPackageId = packageInfo.id;
            currentPackageUrl = packageInfo.url;
            currentVerificationCode = null;

            // Update popup content
            document.getElementById('popupPackageName').textContent = packageInfo.name || 'Exclusive Pack';
            document.getElementById('popupPackageDescription').textContent = packageInfo.description || 'Unlock exclusive content';

            // Set star-shaped pack background image
            const imgElement = document.getElementById('popupPackageImage');
            const imagePath = packageInfo.image ? 'images/' + packageInfo.image : 'images/discover/pack-1.jpg';
            console.log("Setting popup pack image to:", imagePath, "from packageInfo.image:", packageInfo.image);

            imgElement.src = imagePath;
            imgElement.onerror = function() {
                console.log("Pack image failed to load, using default");
                this.src = 'images/discover/pack-1.jpg';
                this.onerror = null;
            };

            // Reset state - show step 1, hide step 2
            document.getElementById('discordIdInput').value = '';
            document.getElementById('redeemStatus').style.display = 'none';
            document.getElementById('discordHelpSection').style.display = 'none';
            document.getElementById('redeemBtn').disabled = false;
            document.getElementById('verifyStep1').style.display = 'block';
            document.getElementById('verifyStep2').style.display = 'none';

            // Show popup (block display for comic bubble)
            document.getElementById('exclusivePackagePopup').style.display = 'block';
        }

        function closeExclusivePopup() {
            document.getElementById('exclusivePackagePopup').style.display = 'none';
            currentPackageId = null;
            currentPackageUrl = null;
            currentVerificationCode = null;
        }

        function openPackageUrl() {
            if (currentPackageUrl) {
                // Send to Lua to open URL
                fetch(`https://${GetParentResourceName()}/openUrl`, {
                    method: 'POST',
                    body: JSON.stringify({ url: currentPackageUrl })
                });
            }
        }

        function toggleDiscordHelp() {
            const helpSection = document.getElementById('discordHelpSection');
            helpSection.style.display = helpSection.style.display === 'none' ? 'block' : 'none';
        }

        function showRedeemStatus(message, type) {
            const status = document.getElementById('redeemStatus');
            status.textContent = message;
            status.className = 'comic-status ' + type;
            status.style.display = 'block';
        }

        function hideRedeemStatus() {
            document.getElementById('redeemStatus').style.display = 'none';
        }

        // Step 1: Request verification code
        function requestVerificationCode() {
            const discordId = document.getElementById('discordIdInput').value.trim();

            if (!discordId) {
                showRedeemStatus('Please enter your Discord ID', 'error');
                return;
            }

            if (!/^\d{17,19}$/.test(discordId)) {
                showRedeemStatus('Invalid Discord ID. It should be a 17-19 digit number.', 'error');
                return;
            }

            // Show loading state
            document.getElementById('redeemBtn').disabled = true;
            showRedeemStatus('Generating verification code...', 'loading');

            // Send to Lua to request a verification code
            fetch(`https://${GetParentResourceName()}/requestVerificationCode`, {
                method: 'POST',
                body: JSON.stringify({
                    discordId: discordId,
                    packageId: currentPackageId
                })
            });
        }

        // Show step 2 with verification code
        function showVerificationCode(code) {
            currentVerificationCode = code;

            // Update code display
            document.getElementById('verificationCodeBox').textContent = code;

            // Hide step 1, show step 2
            document.getElementById('verifyStep1').style.display = 'none';
            document.getElementById('verifyStep2').style.display = 'block';
            hideRedeemStatus();
        }

        // Go back to step 1
        function goBackToStep1() {
            document.getElementById('verifyStep1').style.display = 'block';
            document.getElementById('verifyStep2').style.display = 'none';
            document.getElementById('redeemBtn').disabled = false;
            currentVerificationCode = null;
            hideRedeemStatus();
        }

        // Copy verification code to clipboard
        function copyVerificationCode() {
            const code = currentVerificationCode;
            if (!code) return;

            // Use fallback method for NUI environment
            const textArea = document.createElement('textarea');
            textArea.value = code;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            textArea.style.top = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                const copyBtn = document.querySelector('.comic-btn-copy');
                copyBtn.innerHTML = '<span>‚úì</span> Copied!';
                copyBtn.classList.add('copied');

                setTimeout(() => {
                    copyBtn.innerHTML = '<span>üìã</span> Copy Code';
                    copyBtn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }

            document.body.removeChild(textArea);
        }

        // Discord invite URL (set from Lua config)
        let discordInviteUrl = 'https://discord.com/invite/PjN7AWqkpF';

        // Toggle Discord invite section
        function toggleDiscordInvite() {
            const toggle = document.getElementById('discordInviteToggle');
            const content = document.getElementById('discordInviteContent');
            const isVisible = content.style.display !== 'none';

            if (isVisible) {
                content.style.display = 'none';
                toggle.classList.remove('active');
            } else {
                content.style.display = 'block';
                toggle.classList.add('active');
            }
        }

        // Open Discord invite URL
        function openDiscordInvite() {
            if (discordInviteUrl) {
                fetch(`https://${GetParentResourceName()}/openUrl`, {
                    method: 'POST',
                    body: JSON.stringify({ url: discordInviteUrl })
                });
            }
        }

        // VIP Translations (set from Lua)
        let vipTranslations = {};

        // Apply translations to popup
        function applyVIPTranslations(translations) {
            if (!translations) return;
            vipTranslations = translations;

            // Update popup text elements
            const elements = {
                'popupPackageName': translations.unlock_title || 'Exclusive Content',
                'popupPackageDescription': translations.unlock_description || 'Unlock exclusive content',
                'discordIdInput': { placeholder: translations.verify_placeholder || 'Enter your Discord ID...' },
                'redeemBtn': translations.verify_button || 'Get Verification Code',
                'discordInviteText': translations.discord_prompt || 'Want to find our Discord?',
                'discordJoinText': translations.discord_join || 'Join Discord'
            };

            for (const [id, value] of Object.entries(elements)) {
                const el = document.getElementById(id);
                if (el) {
                    if (typeof value === 'object') {
                        if (value.placeholder) el.placeholder = value.placeholder;
                    } else if (el.tagName === 'BUTTON' || el.tagName === 'SPAN') {
                        el.textContent = value;
                    }
                }
            }
        }

        // Handle messages from Lua
        window.addEventListener('message', (event) => {
            const data = event.data;

            if (data.action === 'showExclusivePopup') {
                showExclusivePopup(data.packageInfo);
            } else if (data.action === 'verificationCodeGenerated') {
                // Code was generated successfully - show step 2
                document.getElementById('redeemBtn').disabled = false;

                if (data.success) {
                    showVerificationCode(data.code);
                } else {
                    showRedeemStatus(data.message || 'Failed to generate code. Please try again.', 'error');
                }
            } else if (data.action === 'verificationComplete') {
                // Verification complete from Discord bot callback
                if (data.success) {
                    // Show success in step 2
                    const waitingDiv = document.querySelector('.verification-waiting');
                    if (waitingDiv) {
                        waitingDiv.innerHTML = '<span style="color: #38ef7d; font-size: 16px;">‚úì Verified!</span>';
                    }
                    showRedeemStatus(data.message || '‚úì Discord verified! Refreshing...', 'success');

                    // Refresh equipment
                    fetch(`https://${GetParentResourceName()}/refreshEquipment`, {
                        method: 'POST',
                        body: JSON.stringify({})
                    });

                    // Close popup after success
                    setTimeout(() => {
                        closeExclusivePopup();
                    }, 1500);
                } else {
                    showRedeemStatus(data.message || 'Verification failed. Please try again.', 'error');
                }
            } else if (data.action === 'discordVerifyResult') {
                // Legacy handler (keeping for backward compatibility)
                document.getElementById('redeemBtn').disabled = false;

                if (data.success) {
                    showRedeemStatus(data.message || '‚úì Success! Refreshing...', 'success');

                    fetch(`https://${GetParentResourceName()}/refreshEquipment`, {
                        method: 'POST',
                        body: JSON.stringify({})
                    });

                    setTimeout(() => {
                        closeExclusivePopup();
                    }, 800);
                } else {
                    showRedeemStatus(data.message || 'Verification failed. Please try again.', 'error');
                }
            } else if (data.action === 'closeExclusivePopup') {
                closeExclusivePopup();
            } else if (data.action === 'openUrlExternal') {
                // Open URL in Steam overlay browser (FiveM native method)
                if (data.url && window.invokeNative) {
                    window.invokeNative('openUrl', data.url);
                } else if (data.url) {
                    // Fallback: open in new tab (for development/testing)
                    window.open(data.url, '_blank');
                }
            } else if (data.action === 'setVIPTranslations') {
                // Apply translations from Lua config
                applyVIPTranslations(data.translations);
            } else if (data.action === 'setDiscordInviteUrl') {
                // Set Discord invite URL from config
                if (data.url) {
                    discordInviteUrl = data.url;
                }
            } else if (data.action === 'setVIPConfig') {
                // Combined: set translations and Discord URL together
                if (data.translations) {
                    applyVIPTranslations(data.translations);
                }
                if (data.discordInviteUrl) {
                    discordInviteUrl = data.discordInviteUrl;
                }
            }
        });

        // Close popup on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('exclusivePackagePopup').style.display !== 'none') {
                closeExclusivePopup();
            }
        });
    </script>

    <!-- Gear Wheel Script -->
    <script src="gear-wheel.js"></script>

    <!-- Equipment System Script -->
    <script src="equipment.js"></script>
</body>

</html>
